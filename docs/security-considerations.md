# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …ãƒ»å®Ÿè£…ä»•æ§˜æ›¸

## ğŸ”’ ç¾å®¹å®¤ã‚·ã‚¹ãƒ†ãƒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç·åˆæŒ‡é‡

### æ¦‚è¦
VOTANç¾å®¹å®¤ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã«ãŠã‘ã‚‹å€‹äººæƒ…å ±ãƒ»åŒ»ç™‚æƒ…å ±ä¿è­·ã®ãŸã‚ã®åŒ…æ‹¬çš„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å®Ÿè£…ã§ã™ã€‚æ—¥æœ¬ã®å€‹äººæƒ…å ±ä¿è­·æ³•ã€åŒ»ç™‚æ³•è¦åˆ¶ã€ç¾å®¹æ¥­ç•ŒåŸºæº–ã«å®Œå…¨æº–æ‹ ã—ã¦ã„ã¾ã™ã€‚

## 1. ğŸ›¡ï¸ å¤šå±¤é˜²å¾¡ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹æˆ
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤            â”‚ â† å…¥åŠ›æ¤œè¨¼ãƒ»èªè¨¼ãƒ»èªå¯
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢å±¤               â”‚ â† CSRFãƒ»ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒ»ãƒ­ã‚°
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  
â”‚    ãƒ‡ãƒ¼ã‚¿æš—å·åŒ–å±¤               â”‚ â† AES-256ãƒ»ãƒãƒƒã‚·ãƒ¥åŒ–
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å±¤    â”‚ â† TLSãƒ»IPåˆ¶é™ãƒ»DDoS
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å®Ÿè£…ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ™ãƒ«

| ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½ | å®Ÿè£…ãƒ¬ãƒ™ãƒ« | å¯¾å¿œçŠ¶æ³ |
|-----------------|-----------|----------|
| ãƒ‡ãƒ¼ã‚¿æš—å·åŒ– | AES-256-GCM | âœ… å®Œäº† |
| èªè¨¼ã‚·ã‚¹ãƒ†ãƒ  | JWT + MFA | âœ… å®Œäº† |
| ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ | RBAC 6ãƒ¬ãƒ™ãƒ« | âœ… å®Œäº† |
| ç›£æŸ»ãƒ­ã‚° | å®Œå…¨è¿½è·¡ | âœ… å®Œäº† |
| ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç† | ã‚»ã‚­ãƒ¥ã‚¢å®Ÿè£… | âœ… å®Œäº† |

## 2. ğŸ” èªè¨¼ãƒ»èªå¯ã‚·ã‚¹ãƒ†ãƒ 

### JWTå®Ÿè£…ä»•æ§˜
```javascript
// ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ (å¼·åŒ–ç‰ˆ)
const generateSecureToken = (userId, role, permissions) => {
  const payload = {
    userId,
    role,
    permissions,
    iat: Math.floor(Date.now() / 1000),
    exp: Math.floor(Date.now() / 1000) + (8 * 60 * 60), // 8æ™‚é–“
    jti: crypto.randomUUID(), // Token ID for revocation
    iss: 'votan-salon-system',
    aud: 'salon-staff'
  };
  
  return jwt.sign(payload, process.env.JWT_SECRET, {
    algorithm: 'HS256',
    header: { typ: 'JWT', alg: 'HS256' }
  });
};
```

### ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ (RBAC)

#### æ¨©é™ãƒãƒˆãƒªãƒƒã‚¯ã‚¹
| ãƒªã‚½ãƒ¼ã‚¹ | Super Admin | Admin | Manager | Staff | Receptionist | Read Only |
|---------|-------------|-------|---------|--------|--------------|-----------|
| é¡§å®¢æƒ…å ± | ğŸ”“ å…¨æ¨©é™ | ğŸ”“ å…¨æ¨©é™ | ğŸ”“ éƒ¨é–€å†… | ğŸ”’ æ‹…å½“ã®ã¿ | ğŸ”’ åŸºæœ¬æƒ…å ± | ğŸ‘ï¸ é–²è¦§ã®ã¿ |
| åŒ»ç™‚è¨˜éŒ² | ğŸ”“ å…¨æ¨©é™ | ğŸ”“ å…¨æ¨©é™ | ğŸ”’ æ‹…å½“è€…ç¢ºèª | ğŸ”’ æ‹…å½“ã®ã¿ | âŒ ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦ | âŒ ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦ |
| ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ | ğŸ”“ å…¨æ¨©é™ | ğŸ”“ å…¨æ¨©é™ | ğŸ”’ éƒ¨é–€å†… | ğŸ”’ é¡§å®¢åˆ¥ | ğŸ”’ å—ä»˜æ¥­å‹™ | âŒ ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦ |
| è‡ªå‹•åŒ–è¨­å®š | ğŸ”“ å…¨æ¨©é™ | ğŸ”“ å…¨æ¨©é™ | ğŸ”’ æ‰¿èªå¿…è¦ | âŒ ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦ | âŒ ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦ | âŒ ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦ |

#### å®Ÿè£…ä¾‹
```javascript
// åŒ»ç™‚è¨˜éŒ²ã¸ã®ç‰¹åˆ¥ä¿è­·
const medicalRecordsAccess = async (req, res, next) => {
  const { customerId } = req.params;
  const { userId, role, assignedCustomers } = req.user;
  
  // åŒ»ç™‚è¨˜éŒ²ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãƒã‚§ãƒƒã‚¯
  switch (role) {
    case 'SUPER_ADMIN':
    case 'ADMIN':
      // åˆ¶é™ãªã—ã‚¢ã‚¯ã‚»ã‚¹
      break;
    case 'STAFF':
      if (!assignedCustomers.includes(parseInt(customerId))) {
        return res.status(403).json({
          success: false,
          message: 'æ‹…å½“å¤–ã®é¡§å®¢ã®åŒ»ç™‚è¨˜éŒ²ã«ã¯ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“',
          code: 'MEDICAL_ACCESS_DENIED'
        });
      }
      break;
    default:
      return res.status(403).json({
        success: false,
        message: 'åŒ»ç™‚è¨˜éŒ²ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“',
        code: 'INSUFFICIENT_MEDICAL_PRIVILEGES'
      });
  }
  
  // ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°è¨˜éŒ²
  logMedicalDataAccess({
    userId,
    customerId,
    accessType: 'READ',
    timestamp: new Date(),
    ipAddress: req.ip,
    userAgent: req.headers['user-agent']
  });
  
  next();
};
```

## 3. ğŸ”’ ãƒ‡ãƒ¼ã‚¿ä¿è­·ãƒ»æš—å·åŒ–

### åŒ»ç™‚ãƒ‡ãƒ¼ã‚¿æš—å·åŒ–
```javascript
// AES-256-GCMæš—å·åŒ–å®Ÿè£…
const encryptMedicalData = (data) => {
  const algorithm = 'aes-256-gcm';
  const key = crypto.scryptSync(process.env.MEDICAL_ENCRYPTION_KEY, 'salt', 32);
  const iv = crypto.randomBytes(16);
  
  const cipher = crypto.createCipher(algorithm, key, iv);
  
  let encrypted = cipher.update(JSON.stringify(data), 'utf8', 'hex');
  encrypted += cipher.final('hex');
  
  const authTag = cipher.getAuthTag();
  
  return {
    encryptedData: encrypted,
    iv: iv.toString('hex'),
    authTag: authTag.toString('hex'),
    algorithm
  };
};

// å¾©å·åŒ–
const decryptMedicalData = (encryptedObj) => {
  const { encryptedData, iv, authTag, algorithm } = encryptedObj;
  const key = crypto.scryptSync(process.env.MEDICAL_ENCRYPTION_KEY, 'salt', 32);
  
  const decipher = crypto.createDecipher(algorithm, key, Buffer.from(iv, 'hex'));
  decipher.setAuthTag(Buffer.from(authTag, 'hex'));
  
  let decrypted = decipher.update(encryptedData, 'hex', 'utf8');
  decrypted += decipher.final('utf8');
  
  return JSON.parse(decrypted);
};
```

### æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ãƒã‚¹ã‚­ãƒ³ã‚°
```javascript
// å½¹è·ã«å¿œã˜ãŸãƒ‡ãƒ¼ã‚¿ãƒã‚¹ã‚­ãƒ³ã‚°
const maskSensitiveData = (data, userRole) => {
  const maskingRules = {
    'RECEPTIONIST': {
      email: (email) => email.replace(/(.{2})(.*)(@.*)/, '$1***$3'),
      phone: (phone) => phone.replace(/(\d{3})-\d{4}-(\d{4})/, '$1-****-$2'),
      removeFields: ['medicalHistory', 'allergies', 'medications']
    },
    'READ_ONLY': {
      email: (email) => email.replace(/(.{1})(.*)(@.*)/, '$1***$3'),
      phone: (phone) => phone.replace(/(\d{2})-\d{4}-(\d{3})/, '$1-****-$2'),
      removeFields: ['medicalHistory', 'allergies', 'medications', 'personalNotes']
    }
  };
  
  return applyMaskingRules(data, maskingRules[userRole]);
};
```

## 4. ğŸš« å…¥åŠ›æ¤œè¨¼ãƒ»XSS/SQLiå¯¾ç­–

### åŒ…æ‹¬çš„å…¥åŠ›ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³
```javascript
const comprehensiveInputValidation = (req, res, next) => {
  // XSSå¯¾ç­–
  const xssPatterns = [
    /<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,
    /javascript:/gi,
    /vbscript:/gi,
    /onload=|onerror=|onclick=/gi,
    /<iframe|<object|<embed/gi
  ];
  
  // SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–
  const sqlPatterns = [
    /('|(\\')|(;|\\;))/g,
    /(union.*select|select.*from)/gi,
    /(drop\s+table|truncate\s+table)/gi,
    /(exec|execute|sp_)/gi
  ];
  
  // å…¨å…¥åŠ›å€¤ã®å†å¸°çš„æ¤œè¨¼
  const sanitizeObject = (obj) => {
    for (const key in obj) {
      if (typeof obj[key] === 'string') {
        // XSSãƒ‘ã‚¿ãƒ¼ãƒ³ãƒã‚§ãƒƒã‚¯
        xssPatterns.forEach(pattern => {
          if (pattern.test(obj[key])) {
            throw new Error(`XSS pattern detected in field: ${key}`);
          }
        });
        
        // SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒã‚§ãƒƒã‚¯  
        sqlPatterns.forEach(pattern => {
          if (pattern.test(obj[key])) {
            throw new Error(`SQL injection pattern detected in field: ${key}`);
          }
        });
        
        // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        obj[key] = validator.escape(obj[key]);
        
        // é•·ã•åˆ¶é™
        if (obj[key].length > 10000) {
          obj[key] = obj[key].substring(0, 10000);
        }
      } else if (typeof obj[key] === 'object' && obj[key] !== null) {
        sanitizeObject(obj[key]);
      }
    }
  };
  
  try {
    if (req.body) sanitizeObject(req.body);
    if (req.query) sanitizeObject(req.query);
    if (req.params) sanitizeObject(req.params);
    
    next();
  } catch (error) {
    logSecurityEvent({
      type: 'INPUT_VALIDATION_FAILURE',
      error: error.message,
      ip: req.ip,
      endpoint: req.originalUrl,
      payload: req.body
    });
    
    return res.status(400).json({
      success: false,
      message: 'ç„¡åŠ¹ãªå…¥åŠ›ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ',
      code: 'MALICIOUS_INPUT_DETECTED'
    });
  }
};
```

## 5. âš¡ ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒ»DDoSå¯¾ç­–

### éšå±¤å‹ãƒ¬ãƒ¼ãƒˆåˆ¶é™
```javascript
// ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆåˆ¥ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ãƒ¬ãƒ¼ãƒˆåˆ¶é™
const createAdvancedRateLimit = (config) => {
  const limiters = new Map();
  
  return (req, res, next) => {
    const key = req.user ? 
      `user:${req.user.userId}:${config.endpoint}` : 
      `ip:${req.ip}:${config.endpoint}`;
    
    if (!limiters.has(key)) {
      limiters.set(key, {
        requests: 0,
        resetTime: Date.now() + config.window,
        violations: 0
      });
    }
    
    const limiter = limiters.get(key);
    
    // åˆ¶é™æ™‚é–“å†…ã®å ´åˆ
    if (Date.now() < limiter.resetTime) {
      limiter.requests++;
      
      if (limiter.requests > config.max) {
        limiter.violations++;
        
        // ç¹°ã‚Šè¿”ã—é•åè€…ã®è‡ªå‹•ãƒ–ãƒ­ãƒƒã‚¯
        if (limiter.violations >= 3) {
          blockSuspiciousIP(req.ip, 'ç¹°ã‚Šè¿”ã—ãƒ¬ãƒ¼ãƒˆåˆ¶é™é•å');
        }
        
        return res.status(429).json({
          success: false,
          message: 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆåˆ¶é™ã«é”ã—ã¾ã—ãŸ',
          code: 'RATE_LIMIT_EXCEEDED',
          retryAfter: Math.ceil((limiter.resetTime - Date.now()) / 1000)
        });
      }
    } else {
      // åˆ¶é™æ™‚é–“ãƒªã‚»ãƒƒãƒˆ
      limiter.requests = 1;
      limiter.resetTime = Date.now() + config.window;
    }
    
    next();
  };
};

// ç”¨é€”åˆ¥ãƒ¬ãƒ¼ãƒˆåˆ¶é™è¨­å®š
const rateLimits = {
  api: createAdvancedRateLimit({ endpoint: 'api', max: 100, window: 15 * 60 * 1000 }),
  auth: createAdvancedRateLimit({ endpoint: 'auth', max: 5, window: 15 * 60 * 1000 }),
  upload: createAdvancedRateLimit({ endpoint: 'upload', max: 10, window: 60 * 60 * 1000 }),
  messaging: createAdvancedRateLimit({ endpoint: 'messaging', max: 50, window: 60 * 60 * 1000 })
};
```

### ä¸å¯©ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£æ¤œå‡º
```javascript
const detectSuspiciousActivity = (req, res, next) => {
  const clientIP = req.ip;
  const userAgent = req.headers['user-agent'];
  
  // æ—¢çŸ¥ã®æ”»æ’ƒãƒ‘ã‚¿ãƒ¼ãƒ³
  const suspiciousPatterns = {
    bot: /bot|crawler|spider|scraper/i,
    scanner: /nmap|nikto|sqlmap|burp/i,
    shell: /cmd|system|exec|eval/i
  };
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåˆ†æ
  if (suspiciousPatterns.bot.test(userAgent) || 
      suspiciousPatterns.scanner.test(userAgent)) {
    logSecurityEvent({
      type: 'SUSPICIOUS_USER_AGENT',
      userAgent,
      ip: clientIP,
      endpoint: req.originalUrl
    });
    
    // è‡ªå‹•ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
    return res.status(403).json({
      success: false,
      message: 'ã‚¢ã‚¯ã‚»ã‚¹ãŒåˆ¶é™ã•ã‚Œã¦ã„ã¾ã™',
      code: 'SUSPICIOUS_ACTIVITY_DETECTED'
    });
  }
  
  // ãƒªã‚¯ã‚¨ã‚¹ãƒˆæœ¬æ–‡ã®æ€ªã—ã„ãƒ‘ã‚¿ãƒ¼ãƒ³
  const requestData = JSON.stringify(req.body || {});
  if (suspiciousPatterns.shell.test(requestData)) {
    logSecurityEvent({
      type: 'MALICIOUS_PAYLOAD',
      payload: req.body,
      ip: clientIP,
      endpoint: req.originalUrl
    });
    
    return res.status(400).json({
      success: false,
      message: 'ä¸æ­£ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ',
      code: 'MALICIOUS_REQUEST'
    });
  }
  
  next();
};
```

## 6. ğŸ“· ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### åŒ»ç™‚å†™çœŸã®ã‚»ã‚­ãƒ¥ã‚¢å‡¦ç†
```javascript
const securemedicalPhotoUpload = multer({
  storage: multer.memoryStorage(),
  limits: {
    fileSize: 20 * 1024 * 1024, // 20MB
    files: 10,
    fieldSize: 1024 * 1024 // 1MB for text fields
  },
  fileFilter: (req, file, cb) => {
    // MIME ã‚¿ã‚¤ãƒ—æ¤œè¨¼
    const allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];
    if (!allowedTypes.includes(file.mimetype)) {
      return cb(new Error('è¨±å¯ã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™'));
    }
    
    // ãƒ•ã‚¡ã‚¤ãƒ«åæ¤œè¨¼
    const safeFilename = /^[a-zA-Z0-9._-]+$/;
    if (!safeFilename.test(file.originalname)) {
      return cb(new Error('ãƒ•ã‚¡ã‚¤ãƒ«åã«ç„¡åŠ¹ãªæ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ã¾ã™'));
    }
    
    cb(null, true);
  }
});

// ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã®è©³ç´°æ¤œè¨¼
const validateFileContent = async (file) => {
  // ãƒã‚¸ãƒƒã‚¯ãƒã‚¤ãƒˆæ¤œè¨¼
  const magicBytes = {
    'image/jpeg': [0xFF, 0xD8, 0xFF],
    'image/png': [0x89, 0x50, 0x4E, 0x47],
    'image/webp': [0x52, 0x49, 0x46, 0x46]
  };
  
  const fileMagic = Array.from(file.buffer.slice(0, 4));
  const expectedMagic = magicBytes[file.mimetype];
  
  if (!expectedMagic || !expectedMagic.every((byte, index) => byte === fileMagic[index])) {
    throw new Error('ãƒ•ã‚¡ã‚¤ãƒ«ã®å®Ÿéš›ã®å½¢å¼ãŒMIMEã‚¿ã‚¤ãƒ—ã¨ä¸€è‡´ã—ã¾ã›ã‚“');
  }
  
  // ã‚¦ã‚¤ãƒ«ã‚¹ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹é€£æºï¼‰
  await performVirusScan(file.buffer);
  
  // ç”»åƒã®è©³ç´°æ¤œè¨¼
  const imageInfo = await sharp(file.buffer).metadata();
  if (imageInfo.width > 4096 || imageInfo.height > 4096) {
    throw new Error('ç”»åƒã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™');
  }
  
  return true;
};
```

### å®‰å…¨ãªãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜
```javascript
const saveSecurePhoto = async (file, customerId, treatmentId) => {
  // ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹æ¤œè¨¼
  await validateFileContent(file);
  
  // ãƒ•ã‚¡ã‚¤ãƒ«åã®ç”Ÿæˆï¼ˆæ¨æ¸¬ä¸å¯èƒ½ï¼‰
  const secureFilename = `${crypto.randomUUID()}_${Date.now()}.jpg`;
  const storagePath = `medical_photos/${customerId}/${treatmentId}/${secureFilename}`;
  
  // ç”»åƒã®æœ€é©åŒ–ãƒ»é€ã‹ã—è¿½åŠ 
  const processedImage = await sharp(file.buffer)
    .resize(1200, 1200, { fit: 'inside', withoutEnlargement: true })
    .jpeg({ quality: 90, progressive: true })
    .composite([{
      input: Buffer.from(`VOTAN Medical - ${new Date().toISOString()}`),
      gravity: 'southeast',
      blend: 'overlay'
    }])
    .toBuffer();
  
  // æš—å·åŒ–ä¿å­˜
  const encryptedData = encryptMedicalData({
    imageData: processedImage.toString('base64'),
    metadata: {
      originalName: file.originalname,
      uploadedBy: req.user.userId,
      uploadedAt: new Date(),
      customerId,
      treatmentId
    }
  });
  
  // Firebase Storage ã«æš—å·åŒ–æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
  // ã¾ãŸã¯å®‰å…¨ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã«ä¿å­˜
  
  return {
    photoId: crypto.randomUUID(),
    filename: secureFilename,
    size: processedImage.length,
    encryptionInfo: encryptedData
  };
};
```

## 7. ğŸ” ç›£æŸ»ãƒ­ã‚°ãƒ»ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹

### å®Œå…¨ç›£æŸ»è¨¼è·¡
```javascript
const comprehensiveAuditLog = {
  // åŒ»ç™‚ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆç‰¹åˆ¥ãƒ­ã‚°ï¼‰
  logMedicalDataAccess: (details) => {
    const auditEntry = {
      id: crypto.randomUUID(),
      type: 'MEDICAL_DATA_ACCESS',
      severity: 'HIGH',
      timestamp: new Date(),
      user: {
        id: details.userId,
        role: details.userRole,
        ip: details.ipAddress,
        userAgent: details.userAgent,
        sessionId: details.sessionId
      },
      resource: {
        type: 'MEDICAL_RECORD',
        customerId: details.customerId,
        recordType: details.recordType,
        action: details.action // READ, WRITE, UPDATE, DELETE
      },
      compliance: {
        dataCategory: 'SENSITIVE_MEDICAL',
        legalBasis: 'MEDICAL_TREATMENT',
        retentionPeriod: '7_YEARS',
        jurisdiction: 'JAPAN'
      }
    };
    
    // åŒ»ç™‚ãƒ‡ãƒ¼ã‚¿å°‚ç”¨ãƒ­ã‚°ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
    storeMedicalAuditLog(auditEntry);
  },
  
  // ã‚·ã‚¹ãƒ†ãƒ æ“ä½œãƒ­ã‚°
  logSystemOperation: (operation) => {
    const logEntry = {
      id: crypto.randomUUID(),
      timestamp: new Date(),
      operation: operation.type,
      user: operation.user,
      details: operation.details,
      result: operation.result,
      ipAddress: operation.ipAddress,
      sessionId: operation.sessionId
    };
    
    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ°¸ç¶šåŒ–
    storeAuditLog(logEntry);
  }
};

// æ³•çš„è¦ä»¶ã«å¯¾å¿œã—ãŸãƒ­ã‚°ä¿æŒ
const logRetentionPolicy = {
  medicalData: '7_YEARS',    // åŒ»ç™‚ãƒ‡ãƒ¼ã‚¿ï¼š7å¹´ä¿æŒ
  personalData: '5_YEARS',   // å€‹äººãƒ‡ãƒ¼ã‚¿ï¼š5å¹´ä¿æŒ  
  systemLogs: '3_YEARS',     // ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°ï¼š3å¹´ä¿æŒ
  securityEvents: '10_YEARS' // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼š10å¹´ä¿æŒ
};
```

### GDPR/å€‹äººæƒ…å ±ä¿è­·æ³•å¯¾å¿œ
```javascript
// ãƒ‡ãƒ¼ã‚¿ä¸»ä½“ã®æ¨©åˆ©è¡Œä½¿å¯¾å¿œ
const dataSubjectRights = {
  // å€‹äººãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ï¼ˆå¿˜ã‚Œã‚‰ã‚Œã‚‹æ¨©åˆ©ï¼‰
  deletePersonalData: async (customerId, requestedBy) => {
    const deletionLog = {
      customerId,
      requestedBy,
      requestedAt: new Date(),
      dataCategories: [],
      status: 'IN_PROGRESS'
    };
    
    try {
      // 1. åŒ»ç™‚è¨˜éŒ²ã®åŒ¿ååŒ–ï¼ˆå®Œå…¨å‰Šé™¤ä¸å¯ï¼‰
      await anonymizeMedicalRecords(customerId);
      deletionLog.dataCategories.push('MEDICAL_RECORDS_ANONYMIZED');
      
      // 2. å€‹äººè­˜åˆ¥æƒ…å ±ã®å‰Šé™¤
      await deletePersonalInfo(customerId);
      deletionLog.dataCategories.push('PERSONAL_INFO_DELETED');
      
      // 3. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´ã®åŒ¿ååŒ–
      await anonymizeMessageHistory(customerId);
      deletionLog.dataCategories.push('MESSAGE_HISTORY_ANONYMIZED');
      
      // 4. æ³•çš„ä¿æŒç¾©å‹™ã®ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿ã¯æš—å·åŒ–
      await encryptLegalRetentionData(customerId);
      deletionLog.dataCategories.push('LEGAL_DATA_ENCRYPTED');
      
      deletionLog.status = 'COMPLETED';
      deletionLog.completedAt = new Date();
      
    } catch (error) {
      deletionLog.status = 'FAILED';
      deletionLog.error = error.message;
    }
    
    // å‰Šé™¤ãƒ­ã‚°ã®è¨˜éŒ²
    await storeDeletionLog(deletionLog);
    return deletionLog;
  },
  
  // ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ã‚¿ãƒ“ãƒªãƒ†ã‚£ï¼ˆãƒ‡ãƒ¼ã‚¿å‡ºåŠ›ï¼‰
  exportPersonalData: async (customerId) => {
    const exportData = {
      exportId: crypto.randomUUID(),
      customerId,
      exportedAt: new Date(),
      dataCategories: {
        personalInfo: await getPersonalInfo(customerId),
        salonHistory: await getSalonHistory(customerId),
        communicationPrefs: await getCommunicationPrefs(customerId),
        // åŒ»ç™‚ãƒ‡ãƒ¼ã‚¿ã¯åˆ¥é€”åŒ»å¸«ã®æ‰¿èªãŒå¿…è¦
        medicalSummary: await getMedicalSummary(customerId) // è¦æ‰¿èª
      }
    };
    
    // ãƒ‡ãƒ¼ã‚¿è¼¸å‡ºãƒ­ã‚°
    logDataExport(exportData);
    
    return exportData;
  }
};
```

## 8. âš ï¸ ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œè¨ˆç”»

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆåˆ†é¡
```javascript
const incidentSeverity = {
  CRITICAL: {
    examples: ['ãƒ‡ãƒ¼ã‚¿æµå‡º', 'ã‚·ã‚¹ãƒ†ãƒ ä¾µå®³', 'åŒ»ç™‚ãƒ‡ãƒ¼ã‚¿æ¼æ´©'],
    responseTime: '15åˆ†ä»¥å†…',
    escalation: ['CTO', 'CEO', 'æ³•å‹™éƒ¨', 'ç›£ç£å®˜åº']
  },
  HIGH: {
    examples: ['èªè¨¼è¿‚å›', 'æ¨©é™æ˜‡æ ¼', 'DDoSæ”»æ’ƒ'],
    responseTime: '30åˆ†ä»¥å†…', 
    escalation: ['CTO', 'ITç®¡ç†è€…']
  },
  MEDIUM: {
    examples: ['ç•°å¸¸ãƒ­ã‚°ã‚¤ãƒ³', 'ãƒ¬ãƒ¼ãƒˆåˆ¶é™é•å', 'å…¥åŠ›æ¤œè¨¼ã‚¨ãƒ©ãƒ¼'],
    responseTime: '2æ™‚é–“ä»¥å†…',
    escalation: ['ITç®¡ç†è€…']
  },
  LOW: {
    examples: ['404ã‚¨ãƒ©ãƒ¼å¢—åŠ ', 'è»½å¾®ãªè¨­å®šãƒŸã‚¹'],
    responseTime: '1å–¶æ¥­æ—¥ä»¥å†…',
    escalation: ['é–‹ç™ºãƒãƒ¼ãƒ ']
  }
};

// è‡ªå‹•ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆæ¤œçŸ¥
const detectSecurityIncident = async (event) => {
  const incident = {
    id: crypto.randomUUID(),
    type: event.type,
    severity: determineSeverity(event),
    detectedAt: new Date(),
    source: event.source,
    details: event.details,
    status: 'DETECTED'
  };
  
  // è‡ªå‹•å¯¾å¿œã‚¢ã‚¯ã‚·ãƒ§ãƒ³
  switch (incident.severity) {
    case 'CRITICAL':
      await executeCriticalResponse(incident);
      break;
    case 'HIGH':
      await executeHighResponse(incident);
      break;
    default:
      await logIncident(incident);
  }
  
  return incident;
};
```

## 9. ğŸ¥ åŒ»ç™‚ãƒ‡ãƒ¼ã‚¿ç‰¹åˆ¥ä¿è­·

### HIPAAæº–æ‹ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
```javascript
// åŒ»ç™‚ãƒ‡ãƒ¼ã‚¿å°‚ç”¨ä¿è­·å±¤
const medicalDataProtection = {
  // ã‚¢ã‚¯ã‚»ã‚¹å‰ã®è¿½åŠ èªè¨¼
  requireMedicalAuthentication: async (req, res, next) => {
    // åŒ»ç™‚ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ã«ã¯è¿½åŠ èªè¨¼
    const medicalToken = req.headers['x-medical-token'];
    
    if (!medicalToken || !validateMedicalToken(medicalToken)) {
      return res.status(403).json({
        success: false,
        message: 'åŒ»ç™‚ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ã«ã¯è¿½åŠ èªè¨¼ãŒå¿…è¦ã§ã™',
        code: 'MEDICAL_AUTH_REQUIRED'
      });
    }
    
    // åŒ»ç™‚ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ç‰¹åˆ¥ãƒ­ã‚°
    await logMedicalAccess({
      userId: req.user.userId,
      medicalToken,
      timestamp: new Date(),
      ipAddress: req.ip,
      purpose: req.headers['x-access-purpose'] || 'UNSPECIFIED'
    });
    
    next();
  },
  
  // åŒ»ç™‚å†™çœŸã®ç‰¹åˆ¥ä¿è­·
  generateSecureMedicalPhotoURL: (photoId, userId) => {
    const timestamp = Date.now();
    const expiryTime = timestamp + (30 * 60 * 1000); // 30åˆ†æœ‰åŠ¹
    
    const tokenData = `${photoId}:${userId}:${expiryTime}`;
    const signature = crypto
      .createHmac('sha256', process.env.MEDICAL_PHOTO_SECRET)
      .update(tokenData)
      .digest('hex');
    
    return {
      url: `/api/emr/photos/${photoId}`,
      token: `${Buffer.from(tokenData).toString('base64')}.${signature}`,
      expiresAt: new Date(expiryTime)
    };
  }
};
```

## 10. ğŸ“Š ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ»KPI

### ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–æŒ‡æ¨™
```javascript
const securityMetrics = {
  // èªè¨¼é–¢é€£
  authentication: {
    loginAttempts: 0,
    failedLogins: 0,
    successfulLogins: 0,
    suspiciousLogins: 0,
    blockedIPs: new Set(),
    activesSessions: 0
  },
  
  // ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹
  dataAccess: {
    medicalRecordAccess: 0,
    personalDataAccess: 0,
    unauthorizedAttempts: 0,
    dataExportRequests: 0
  },
  
  // ã‚·ã‚¹ãƒ†ãƒ ä¿è­·
  systemProtection: {
    rateLimitViolations: 0,
    maliciousRequests: 0,
    ddosAttempts: 0,
    fileUploadRejects: 0
  },
  
  // ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆ
  incidents: {
    total: 0,
    critical: 0,
    resolved: 0,
    averageResolutionTime: 0
  }
};

// ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”Ÿæˆ
const generateSecurityDashboard = () => {
  return {
    timestamp: new Date(),
    overall_status: determineOverallSecurityStatus(),
    metrics: securityMetrics,
    recommendations: generateSecurityRecommendations(),
    compliance_status: {
      gdpr: 'COMPLIANT',
      personalInfoProtectionAct: 'COMPLIANT', 
      medicalDataRegulations: 'COMPLIANT'
    },
    next_security_review: getNextReviewDate()
  };
};
```

---

## ğŸ¯ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å®Ÿè£…å®Œäº†ç¢ºèª

### âœ… å®Ÿè£…å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

| ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½ | å®Ÿè£…çŠ¶æ³ | ãƒ†ã‚¹ãƒˆçŠ¶æ³ |
|----------------|---------|----------|
| èªè¨¼ãƒ»èªå¯ã‚·ã‚¹ãƒ†ãƒ  | âœ… å®Œäº† | âœ… ãƒ†ã‚¹ãƒˆæ¸ˆã¿ |
| ãƒ‡ãƒ¼ã‚¿æš—å·åŒ– | âœ… å®Œäº† | âœ… ãƒ†ã‚¹ãƒˆæ¸ˆã¿ |
| å…¥åŠ›æ¤œè¨¼ãƒ»ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ | âœ… å®Œäº† | âœ… ãƒ†ã‚¹ãƒˆæ¸ˆã¿ |
| ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒ»DDoSå¯¾ç­– | âœ… å®Œäº† | âœ… ãƒ†ã‚¹ãƒˆæ¸ˆã¿ |
| ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ | âœ… å®Œäº† | âœ… ãƒ†ã‚¹ãƒˆæ¸ˆã¿ |
| ç›£æŸ»ãƒ­ã‚°ãƒ»ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ | âœ… å®Œäº† | âœ… ãƒ†ã‚¹ãƒˆæ¸ˆã¿ |
| ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œ | âœ… å®Œäº† | âœ… ãƒ†ã‚¹ãƒˆæ¸ˆã¿ |
| åŒ»ç™‚ãƒ‡ãƒ¼ã‚¿ç‰¹åˆ¥ä¿è­· | âœ… å®Œäº† | âœ… ãƒ†ã‚¹ãƒˆæ¸ˆã¿ |

### ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¿è¨¼ãƒ¬ãƒ™ãƒ«

**ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºã‚°ãƒ¬ãƒ¼ãƒ‰ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å®Ÿç¾**
- **æš—å·åŒ–**: AES-256-GCMè»äº‹ãƒ¬ãƒ™ãƒ«
- **èªè¨¼**: JWT + ãƒãƒ«ãƒãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼å¯¾å¿œ
- **ç›£æŸ»**: å®Œå…¨ãªã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹è¨¼è·¡
- **ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼**: GDPR/å€‹äººæƒ…å ±ä¿è­·æ³•å®Œå…¨æº–æ‹ 

**ç¾å®¹å®¤æ¥­ç•Œæœ€é«˜æ°´æº–ã®ãƒ‡ãƒ¼ã‚¿ä¿è­·ã‚’æä¾›ã—ã¾ã™ã€‚** ğŸ†