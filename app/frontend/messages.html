<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ - Salon LumiÃ¨re</title>
    <link rel="stylesheet" href="/css/main-unified.css?v=20250907">
</head>
<body>
    <button class="mobile-menu-toggle" id="mobileMenuToggle">â˜°</button>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo-wrapper">âœ¨</div>
            <h2 class="salon-name">Salon LumiÃ¨re</h2>
            <span class="plan-badge">PREMIUM</span>
        </div>

        <nav class="nav-menu">
            <a href="/dashboard.html" class="nav-item">
                <span class="nav-icon">ğŸ </span>
                <span>ãƒ›ãƒ¼ãƒ </span>
            </a>
            <a href="/appointments.html" class="nav-item">
                <span class="nav-icon">ğŸ“…</span>
                <span>äºˆç´„</span>
            </a>
            <a href="/customers.html" class="nav-item">
                <span class="nav-icon">ğŸ‘¥</span>
                <span>é¡§å®¢</span>
            </a>
            <a href="/messages.html" class="nav-item active">
                <span class="nav-icon">ğŸ’¬</span>
                <span>é€£çµ¡</span>
            </a>
            <a href="/settings.html" class="nav-item">
                <span class="nav-icon">âš™ï¸</span>
                <span>è¨­å®š</span>
            </a>
        </nav>

        <div class="user-section">
            <div class="user-info">
                <div class="user-avatar">ç®¡</div>
                <div class="user-details">
                    <div class="user-name">ç®¡ç†è€…</div>
                    <div class="user-role">Administrator</div>
                </div>
            </div>
            <button class="logout-btn" id="logoutBtn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
    </aside>

    <main class="main-content">
        <header class="header" style="background: var(--gradient-1); border-radius: 12px; margin-bottom: 1.5rem; box-shadow: var(--shadow-sm);">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div style="background: var(--primary); border-radius: 12px; padding: 12px; color: white; font-size: 1.5rem;">ğŸ’¬</div>
                <div>
                    <h1 class="page-title" style="margin: 0; color: var(--text-dark);">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡</h1>
                    <p style="margin: 0; color: var(--text-light); font-size: 0.9rem;">ãŠå®¢æ§˜ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ãƒ»ç®¡ç†</p>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" id="historyBtn">
                    é€ä¿¡å±¥æ­´
                </button>
                <button class="btn btn-primary" id="quickSendBtn">
                    ã‹ã‚“ãŸã‚“é€ä¿¡
                </button>
            </div>
        </header>
        
        <div class="content-area">
            <!-- Quick Action Cards -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                <div class="quick-action-card" onclick="selectQuickAction('reminder')" style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 1.5rem;
                    border-radius: 16px;
                    cursor: pointer;
                    transition: transform 0.2s;
                    box-shadow: var(--shadow-md);
                ">
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ“…</div>
                    <h3 style="margin: 0 0 0.5rem 0; font-size: 1.1rem;">äºˆç´„ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼</h3>
                    <p style="margin: 0; opacity: 0.9; font-size: 0.9rem;">æ˜æ—¥ã®äºˆç´„ã®ãŠå®¢æ§˜ã«ãƒªãƒã‚¤ãƒ³ãƒ‰</p>
                </div>
                
                <div class="quick-action-card" onclick="selectQuickAction('thanks')" style="
                    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                    color: white;
                    padding: 1.5rem;
                    border-radius: 16px;
                    cursor: pointer;
                    transition: transform 0.2s;
                    box-shadow: var(--shadow-md);
                ">
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ™</div>
                    <h3 style="margin: 0 0 0.5rem 0; font-size: 1.1rem;">æ¥åº—ãŠç¤¼</h3>
                    <p style="margin: 0; opacity: 0.9; font-size: 0.9rem;">ä»Šæ—¥æ¥åº—ã•ã‚ŒãŸãŠå®¢æ§˜ã«ãŠç¤¼</p>
                </div>
                
                <div class="quick-action-card" onclick="selectQuickAction('followup')" style="
                    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
                    color: white;
                    padding: 1.5rem;
                    border-radius: 16px;
                    cursor: pointer;
                    transition: transform 0.2s;
                    box-shadow: var(--shadow-md);
                ">
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ’«</div>
                    <h3 style="margin: 0 0 0.5rem 0; font-size: 1.1rem;">ã‚¢ãƒ•ã‚¿ãƒ¼ãƒ•ã‚©ãƒ­ãƒ¼</h3>
                    <p style="margin: 0; opacity: 0.9; font-size: 0.9rem;">æ–½è¡“å¾Œã®ãŠå®¢æ§˜ã«ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—</p>
                </div>
            </div>

            <!-- Main Message Compose Area -->
            <div class="message-compose-area" style="
                background: var(--white);
                border-radius: 16px;
                box-shadow: var(--shadow-md);
                overflow: hidden;
                border: 1px solid var(--border-color);
            ">

            <!-- Step-by-Step Message Creation -->
            <div class="message-creation-steps">
                <!-- Step 1: Customer Selection -->
                <div class="step-section active" id="step-customer" style="padding: 2rem;">
                    <div class="step-header" style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem;">
                        <div style="background: var(--primary); color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: bold;">1</div>
                        <div>
                            <h2 style="margin: 0; color: var(--text-dark); font-size: 1.3rem;">é€ä¿¡å…ˆã®ãŠå®¢æ§˜ã‚’é¸æŠ</h2>
                            <p style="margin: 0; color: var(--text-light); font-size: 0.9rem;">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹ãŠå®¢æ§˜ã‚’é¸ã‚“ã§ãã ã•ã„</p>
                        </div>
                    </div>
                    
                    <!-- Customer Search -->
                    <div style="margin-bottom: 1.5rem;">
                        <div style="position: relative;">
                            <input type="text" id="customerSearch" placeholder="ãŠå®¢æ§˜åã¾ãŸã¯é›»è©±ç•ªå·ã§æ¤œç´¢..." style="
                                width: 100%;
                                padding: 1rem 1rem 1rem 3rem;
                                border: 2px solid var(--border-color);
                                border-radius: 12px;
                                font-size: 1rem;
                                transition: border-color 0.2s;
                            ">
                            <div style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-light); font-size: 1.2rem;">ğŸ”</div>
                        </div>
                    </div>
                    
                    <!-- Customer Cards -->
                    <div class="customer-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        <div class="customer-card" onclick="selectCustomer('1')" style="
                            background: var(--white);
                            border: 2px solid var(--border-color);
                            border-radius: 12px;
                            padding: 1.5rem;
                            cursor: pointer;
                            transition: all 0.2s;
                            box-shadow: var(--shadow-sm);
                        ">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <div style="width: 60px; height: 60px; background: var(--gradient-2); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; font-weight: bold;">å±±</div>
                                <div style="flex: 1;">
                                    <h3 style="margin: 0 0 0.25rem 0; color: var(--text-dark); font-size: 1.1rem;">å±±ç”° èŠ±å­ æ§˜</h3>
                                    <p style="margin: 0; color: var(--text-light); font-size: 0.9rem;">ğŸ“± 090-1234-5678</p>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: var(--text-light);">
                                <span>ğŸ’… æœ€çµ‚æ¥åº—: 2024/03/10</span>
                                <span>ğŸ¨ ã‚«ãƒƒãƒˆ+ã‚«ãƒ©ãƒ¼</span>
                            </div>
                        </div>
                        
                        <div class="customer-card" onclick="selectCustomer('2')" style="
                            background: var(--white);
                            border: 2px solid var(--border-color);
                            border-radius: 12px;
                            padding: 1.5rem;
                            cursor: pointer;
                            transition: all 0.2s;
                            box-shadow: var(--shadow-sm);
                        ">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <div style="width: 60px; height: 60px; background: var(--gradient-2); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; font-weight: bold;">ä½</div>
                                <div style="flex: 1;">
                                    <h3 style="margin: 0 0 0.25rem 0; color: var(--text-dark); font-size: 1.1rem;">ä½è—¤ ç¾å’² æ§˜</h3>
                                    <p style="margin: 0; color: var(--text-light); font-size: 0.9rem;">ğŸ“± 080-9876-5432</p>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: var(--text-light);">
                                <span>ğŸ’… æœ€çµ‚æ¥åº—: 2024/03/08</span>
                                <span>ğŸŒŠ ãƒ‘ãƒ¼ãƒ+ãƒˆãƒªãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆ</span>
                            </div>
                        </div>
                        
                        <div class="customer-card" onclick="selectCustomer('3')" style="
                            background: var(--white);
                            border: 2px solid var(--border-color);
                            border-radius: 12px;
                            padding: 1.5rem;
                            cursor: pointer;
                            transition: all 0.2s;
                            box-shadow: var(--shadow-sm);
                        ">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <div style="width: 60px; height: 60px; background: var(--gradient-2); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; font-weight: bold;">éˆ´</div>
                                <div style="flex: 1;">
                                    <h3 style="margin: 0 0 0.25rem 0; color: var(--text-dark); font-size: 1.1rem;">éˆ´æœ¨ çœŸç”±ç¾ æ§˜</h3>
                                    <p style="margin: 0; color: var(--text-light); font-size: 0.9rem;">ğŸ“± 070-1111-2222</p>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: var(--text-light);">
                                <span>ğŸ’… æœ€çµ‚æ¥åº—: 2024/03/05</span>
                                <span>ğŸ’† ãƒ˜ãƒƒãƒ‰ã‚¹ãƒ‘+ãƒˆãƒªãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆ</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- é€ä¿¡æ¡ä»¶è¨­å®š -->
                    <div style="background: var(--gray-50); border-radius: 12px; padding: 1.5rem; margin-top: 1.5rem;">
                        <h3 style="margin: 0 0 1rem 0; color: var(--text-dark);">ğŸ“‹ é€ä¿¡æ¡ä»¶è¨­å®š</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">æ¥åº—æ—¥æ¡ä»¶</label>
                                <select id="visitDateCondition" style="width: 100%; padding: 0.5rem; border: 2px solid var(--border-color); border-radius: 8px;">
                                    <option value="any">ã™ã¹ã¦</option>
                                    <option value="today">ä»Šæ—¥æ¥åº—</option>
                                    <option value="yesterday">æ˜¨æ—¥æ¥åº—</option>
                                    <option value="this-week">ä»Šé€±æ¥åº—</option>
                                    <option value="last-week">å…ˆé€±æ¥åº—</option>
                                    <option value="this-month">ä»Šæœˆæ¥åº—</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">é¡§å®¢ã‚¿ã‚¤ãƒ—</label>
                                <select id="customerType" style="width: 100%; padding: 0.5rem; border: 2px solid var(--border-color); border-radius: 8px;">
                                    <option value="any">ã™ã¹ã¦</option>
                                    <option value="vip">VIPé¡§å®¢ã®ã¿</option>
                                    <option value="regular">å¸¸é€£å®¢ã®ã¿</option>
                                    <option value="new">æ–°è¦é¡§å®¢ã®ã¿</option>
                                    <option value="inactive">ã—ã°ã‚‰ãæ¥åº—ãªã—</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">æ–½è¡“ã‚¿ã‚¤ãƒ—</label>
                                <select id="serviceType" style="width: 100%; padding: 0.5rem; border: 2px solid var(--border-color); border-radius: 8px;">
                                    <option value="any">ã™ã¹ã¦</option>
                                    <option value="cut">ã‚«ãƒƒãƒˆ</option>
                                    <option value="color">ã‚«ãƒ©ãƒ¼</option>
                                    <option value="perm">ãƒ‘ãƒ¼ãƒ</option>
                                    <option value="spa">ãƒ˜ãƒƒãƒ‰ã‚¹ãƒ‘</option>
                                    <option value="treatment">ãƒˆãƒªãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆ</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="background: white; border-radius: 8px; padding: 1rem; border: 2px solid var(--border-color);">
                            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 0.5rem;">
                                <span style="font-weight: 500;">é€ä¿¡å¯¾è±¡è€…:</span>
                                <span id="targetCount" style="color: var(--primary); font-weight: bold;">0åãŒè©²å½“</span>
                            </div>
                            <button class="btn btn-secondary" onclick="previewTargets()" style="width: 100%;">
                                å¯¾è±¡é¡§å®¢ã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                            </button>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 1.5rem;">
                        <button class="btn btn-primary" id="nextToTemplate" style="
                            padding: 1rem 2rem;
                            font-size: 1rem;
                            border-radius: 12px;
                            display: inline-flex;
                            align-items: center;
                            gap: 0.5rem;
                        " disabled>
                            æ¬¡ã¸ï¼šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ <span>â†’</span>
                        </button>
                    </div>
                </div>

                <!-- Step 2: Template Selection -->
                <div class="step-section" id="step-template" style="padding: 2rem; display: none;">
                    <div class="step-header" style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem;">
                        <div style="background: var(--primary); color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: bold;">2</div>
                        <div>
                            <h2 style="margin: 0; color: var(--text-dark); font-size: 1.3rem;">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠ</h2>
                            <p style="margin: 0; color: var(--text-light); font-size: 0.9rem;">ç”¨é€”ã«åˆã‚ã›ã¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸ã‚“ã§ãã ã•ã„</p>
                        </div>
                    </div>
                    
                    <!-- Template Cards -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                        <div class="template-card" onclick="selectTemplate('reminder')" style="
                            background: var(--white);
                            border: 2px solid var(--border-color);
                            border-radius: 12px;
                            padding: 1.5rem;
                            cursor: pointer;
                            transition: all 0.2s;
                            box-shadow: var(--shadow-sm);
                        ">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 12px; font-size: 1.5rem;">ğŸ“…</div>
                                <div>
                                    <h3 style="margin: 0; color: var(--text-dark); font-size: 1.1rem;">äºˆç´„ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼</h3>
                                    <p style="margin: 0; color: var(--text-light); font-size: 0.85rem;">æ˜æ—¥ã®äºˆç´„ç¢ºèª</p>
                                </div>
                            </div>
                            <div style="background: var(--gray-50); border-radius: 8px; padding: 1rem; font-size: 0.9rem; color: var(--text-medium); line-height: 1.4;">
                                "{customer_name}æ§˜ã€æ˜æ—¥{date} {time}ã‹ã‚‰ã®ã”äºˆç´„ã‚’ç¢ºèªã„ãŸã—ã¾ã™ã€‚ã‚«ãƒƒãƒˆ+ã‚«ãƒ©ãƒ¼ã§ãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™ã€‚å¤‰æ›´ãŒã”ã–ã„ã¾ã—ãŸã‚‰ãŠæ°—è»½ã«ã”é€£çµ¡ãã ã•ã„ã€‚"
                            </div>
                        </div>
                        
                        <div class="template-card" onclick="selectTemplate('thanks')" style="
                            background: var(--white);
                            border: 2px solid var(--border-color);
                            border-radius: 12px;
                            padding: 1.5rem;
                            cursor: pointer;
                            transition: all 0.2s;
                            box-shadow: var(--shadow-sm);
                        ">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 12px; padding: 12px; font-size: 1.5rem;">ğŸ™</div>
                                <div>
                                    <h3 style="margin: 0; color: var(--text-dark); font-size: 1.1rem;">æ¥åº—ãŠç¤¼</h3>
                                    <p style="margin: 0; color: var(--text-light); font-size: 0.85rem;">æœ¬æ—¥ã®ã”æ¥åº—ã«æ„Ÿè¬</p>
                                </div>
                            </div>
                            <div style="background: var(--gray-50); border-radius: 8px; padding: 1rem; font-size: 0.9rem; color: var(--text-medium); line-height: 1.4;">
                                "{customer_name}æ§˜ã€æœ¬æ—¥ã¯ã”æ¥åº—ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚{service}ã®ä»•ä¸ŠãŒã‚Šã¯ã„ã‹ãŒã§ã—ã‚‡ã†ã‹ï¼Ÿã¾ãŸã®ãŠè¶Šã—ã‚’ãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™ã€‚"
                            </div>
                        </div>
                        
                        <div class="template-card" onclick="selectTemplate('followup')" style="
                            background: var(--white);
                            border: 2px solid var(--border-color);
                            border-radius: 12px;
                            padding: 1.5rem;
                            cursor: pointer;
                            transition: all 0.2s;
                            box-shadow: var(--shadow-sm);
                        ">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-radius: 12px; padding: 12px; font-size: 1.5rem;">ğŸ’«</div>
                                <div>
                                    <h3 style="margin: 0; color: var(--text-dark); font-size: 1.1rem;">ã‚¢ãƒ•ã‚¿ãƒ¼ãƒ•ã‚©ãƒ­ãƒ¼</h3>
                                    <p style="margin: 0; color: var(--text-light); font-size: 0.85rem;">æ–½è¡“å¾Œã®ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—</p>
                                </div>
                            </div>
                            <div style="background: var(--gray-50); border-radius: 8px; padding: 1rem; font-size: 0.9rem; color: var(--text-medium); line-height: 1.4;">
                                "{customer_name}æ§˜ã€å…ˆæ—¥ã¯{service}ã‚’ã”åˆ©ç”¨ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚é«ªã®èª¿å­ã¯ã„ã‹ãŒã§ã™ã‹ï¼Ÿä½•ã‹ã”è³ªå•ãŒã”ã–ã„ã¾ã—ãŸã‚‰ãŠæ°—è»½ã«ã”é€£çµ¡ãã ã•ã„ã€‚"
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <button class="btn btn-secondary" onclick="goBackToCustomer()" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                            <span>â†</span> æˆ»ã‚‹
                        </button>
                        <button class="btn btn-primary" id="nextToCompose" style="
                            padding: 1rem 2rem;
                            font-size: 1rem;
                            border-radius: 12px;
                            display: inline-flex;
                            align-items: center;
                            gap: 0.5rem;
                        " disabled>
                            æ¬¡ã¸ï¼šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç·¨é›† <span>â†’</span>
                        </button>
                    </div>
                </div>
                
                <!-- Step 3: Compose & Send -->
                <div class="step-section" id="step-compose" style="padding: 2rem; display: none;">
                    <div class="step-header" style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem;">
                        <div style="background: var(--primary); color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: bold;">3</div>
                        <div>
                            <h2 style="margin: 0; color: var(--text-dark); font-size: 1.3rem;">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèªãƒ»é€ä¿¡</h2>
                            <p style="margin: 0; color: var(--text-light); font-size: 0.9rem;">å†…å®¹ã‚’ç¢ºèªã—ã¦é€ä¿¡ã—ã¦ãã ã•ã„</p>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 300px; gap: 2rem;">
                        <!-- Message Edit Area -->
                        <div>
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-dark);">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹</label>
                                <textarea id="messageContent" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..." style="
                                    width: 100%;
                                    min-height: 120px;
                                    padding: 1rem;
                                    border: 2px solid var(--border-color);
                                    border-radius: 12px;
                                    font-size: 1rem;
                                    font-family: var(--font-family-primary);
                                    resize: vertical;
                                    transition: border-color 0.2s;
                                " maxlength="160"></textarea>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-light);">
                                    <span>ğŸ’¡ {customer_name}, {date}, {time}, {service} ãŒä½¿ç”¨ã§ãã¾ã™</span>
                                    <span id="charCount">0/160æ–‡å­—</span>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-dark);">é€ä¿¡ã‚¿ã‚¤ãƒŸãƒ³ã‚°</label>
                                <div style="display: flex; gap: 1rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; background: var(--white);">
                                        <input type="radio" name="sendTiming" value="now" checked>
                                        <span>âš¡ ä»Šã™ãé€ä¿¡</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; background: var(--white);">
                                        <input type="radio" name="sendTiming" value="schedule">
                                        <span>â° äºˆç´„é€ä¿¡</span>
                                    </label>
                                </div>
                                <div id="scheduleInput" style="display: none; margin-top: 1rem;">
                                    <input type="datetime-local" id="scheduleTime" style="
                                        padding: 0.75rem;
                                        border: 2px solid var(--border-color);
                                        border-radius: 8px;
                                        font-size: 1rem;
                                    ">
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 1rem;">
                                <button class="btn btn-secondary" onclick="goBackToTemplate()" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                                    <span>â†</span> æˆ»ã‚‹
                                </button>
                                <button class="btn btn-secondary" id="saveDraftBtn" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                                    <span>ğŸ’¾</span> ä¸‹æ›¸ãä¿å­˜
                                </button>
                                <button class="btn btn-primary" id="sendMessageBtn" style="
                                    flex: 1;
                                    padding: 1rem 2rem;
                                    font-size: 1rem;
                                    border-radius: 12px;
                                    display: inline-flex;
                                    align-items: center;
                                    justify-content: center;
                                    gap: 0.5rem;
                                ">
                                    <span>ğŸ“±</span> é€ä¿¡ã™ã‚‹
                                </button>
                            </div>
                        </div>
                        
                        <!-- Preview Area -->
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-dark);">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</label>
                            <div style="
                                background: var(--gray-900);
                                border-radius: 24px;
                                padding: 1.5rem;
                                color: white;
                                position: relative;
                                margin-bottom: 1rem;
                            ">
                                <div style="background: var(--primary); border-radius: 18px; padding: 1rem; margin-bottom: 1rem;">
                                    <div style="font-weight: 500; margin-bottom: 0.5rem;">Salon LumiÃ¨re</div>
                                    <div id="previewContent" style="line-height: 1.4; font-size: 0.95rem;">
                                        ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã™ã‚‹ã¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
                                    </div>
                                    <div style="font-size: 0.8rem; opacity: 0.8; margin-top: 0.5rem;" id="previewTime">ä»Š</div>
                                </div>
                                
                                <!-- Selected Customer Info -->
                                <div id="selectedCustomerInfo" style="
                                    background: rgba(255,255,255,0.1);
                                    border-radius: 12px;
                                    padding: 1rem;
                                    font-size: 0.9rem;
                                ">
                                    <div style="font-weight: 500; margin-bottom: 0.5rem;">é€ä¿¡å…ˆ</div>
                                    <div id="selectedCustomerDisplay">é¡§å®¢ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    </main>
    
    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">ã‚¿ã‚¤ãƒˆãƒ«</h3>
                <button class="modal-close" onclick="closeModal()">Ã—</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            </div>
        </div>
    </div>
    
    <!-- å¯¾è±¡é¡§å®¢ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="targetPreviewModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px; width: 90%;">
            <div class="modal-header">
                <h3 style="margin: 0; color: var(--text-dark);">é€ä¿¡å¯¾è±¡é¡§å®¢ã®ç¢ºèªãƒ»é™¤å¤–è¨­å®š</h3>
                <button class="modal-close" onclick="closeTargetPreview()">Ã—</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <span style="font-weight: 500; color: var(--text-dark);">é©ç”¨æ¡ä»¶:</span>
                        <span id="appliedConditions" style="color: var(--text-medium); font-size: 0.9rem;"></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>ç·å¯¾è±¡è€…: <strong id="totalTargets">0å</strong></span>
                        <span>é€ä¿¡äºˆå®š: <strong id="finalTargets" style="color: var(--primary);">0å</strong></span>
                    </div>
                </div>
                
                <div style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px;">
                    <div id="targetCustomersList">
                        <!-- å¯¾è±¡é¡§å®¢ãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                    </div>
                </div>
                
                <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-secondary" onclick="closeTargetPreview()">é–‰ã˜ã‚‹</button>
                        <button class="btn btn-primary" onclick="proceedWithTargets()" style="flex: 1;">
                            ã“ã®æ¡ä»¶ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆã«é€²ã‚€
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </main>
    
    <script>
        // ãƒ‡ãƒ¢ç”¨ã®èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¨­å®šï¼ˆã‚¨ãƒ©ãƒ¼å›é¿ï¼‰
        localStorage.setItem('salon_token', 'demo_token_for_messages_page_12345678901234567890');
        localStorage.setItem('salon_user', JSON.stringify({
            id: 'demo_user',
            name: 'ç®¡ç†è€…',
            email: 'admin@salon-lumiere.com',
            role: 'admin'
        }));
        
        // messages.jsã®èª­ã¿è¾¼ã¿ã‚’ç„¡åŠ¹åŒ–ï¼ˆç«¶åˆå›é¿ï¼‰
        window.messagesJsDisabled = true;
    </script>
    
    <script>
        // Message Page Interactive Functionality
        let selectedCustomer = null;
        let selectedTemplate = null;
        let targetCustomers = [];
        let excludedCustomers = new Set();
        
        // ã‚µãƒ³ãƒ—ãƒ«é¡§å®¢ãƒ‡ãƒ¼ã‚¿
        const customersDatabase = [
            { id: '1', name: 'å±±ç”° èŠ±å­', phone: '090-1234-5678', email: 'yamada@email.com', type: 'vip', lastVisit: '2024-03-14', service: 'ã‚«ãƒƒãƒˆ+ã‚«ãƒ©ãƒ¼' },
            { id: '2', name: 'ä½è—¤ ç¾å’²', phone: '080-9876-5432', email: 'sato@email.com', type: 'regular', lastVisit: '2024-03-13', service: 'ãƒ‘ãƒ¼ãƒ+ãƒˆãƒªãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆ' },
            { id: '3', name: 'éˆ´æœ¨ çœŸç”±ç¾', phone: '070-1111-2222', email: 'suzuki@email.com', type: 'new', lastVisit: '2024-03-12', service: 'ãƒ˜ãƒƒãƒ‰ã‚¹ãƒ‘+ãƒˆãƒªãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆ' },
            { id: '4', name: 'ç”°ä¸­ éº»è¡£', phone: '080-7777-8888', email: 'mai@email.com', type: 'regular', lastVisit: '2024-03-15', service: 'ã‚«ãƒƒãƒˆ' },
            { id: '5', name: 'é«˜æ©‹ ç”±ç´€', phone: '090-3333-4444', email: 'yuki@email.com', type: 'vip', lastVisit: '2024-03-14', service: 'ã‚«ãƒƒãƒˆ+ã‚«ãƒ©ãƒ¼+ãƒ‘ãƒ¼ãƒ' },
            { id: '6', name: 'ä¸­æ‘ æµç¾', phone: '070-9999-0000', email: 'emi@email.com', type: 'inactive', lastVisit: '2023-12-20', service: 'ãƒˆãƒªãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆ' }
        ];
        
        // Quick Action Functions
        window.selectQuickAction = function(type) {
            // Auto-select template based on quick action
            selectedTemplate = type;
            showStep('template');
            // Highlight the corresponding template
            setTimeout(() => {
                const templateCard = document.querySelector(`[onclick="selectTemplate('${type}')"]`);
                if (templateCard) {
                    templateCard.click();
                }
            }, 100);
        };
        
        // Customer Selection
        window.selectCustomer = function(customerId) {
            selectedCustomer = customerId;
            
            // Remove previous selection
            document.querySelectorAll('.customer-card').forEach(card => {
                card.style.border = '2px solid var(--border-color)';
                card.style.background = 'var(--white)';
            });
            
            // Highlight selected customer
            const selectedCard = document.querySelector(`[onclick="selectCustomer('${customerId}')"]`);
            selectedCard.style.border = '2px solid var(--primary)';
            selectedCard.style.background = 'var(--primary-50)';
            
            // Enable next button
            document.getElementById('nextToTemplate').disabled = false;
            
            // Update preview
            updateSelectedCustomerDisplay();
        };
        
        // Template Selection
        window.selectTemplate = function(templateType) {
            selectedTemplate = templateType;
            
            // Remove previous selection
            document.querySelectorAll('.template-card').forEach(card => {
                card.style.border = '2px solid var(--border-color)';
                card.style.background = 'var(--white)';
            });
            
            // Highlight selected template
            const selectedCard = document.querySelector(`[onclick="selectTemplate('${templateType}')"]`);
            selectedCard.style.border = '2px solid var(--primary)';
            selectedCard.style.background = 'var(--primary-50)';
            
            // Enable next button
            document.getElementById('nextToCompose').disabled = false;
            
            // Load template content
            loadTemplateContent(templateType);
        };
        
        // Step Navigation
        function showStep(stepName) {
            // Hide all steps
            document.querySelectorAll('.step-section').forEach(step => {
                step.style.display = 'none';
            });
            
            // Show selected step
            document.getElementById(`step-${stepName}`).style.display = 'block';
        }
        
        window.goBackToCustomer = function() {
            showStep('customer');
        };
        
        window.goBackToTemplate = function() {
            showStep('template');
        };
        
        // Template Content Loading
        function loadTemplateContent(templateType) {
            const templates = {
                'reminder': '{customer_name}æ§˜ã€æ˜æ—¥{date} {time}ã‹ã‚‰ã®ã”äºˆç´„ã‚’ç¢ºèªã„ãŸã—ã¾ã™ã€‚ã‚«ãƒƒãƒˆ+ã‚«ãƒ©ãƒ¼ã§ãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™ã€‚å¤‰æ›´ãŒã”ã–ã„ã¾ã—ãŸã‚‰ãŠæ°—è»½ã«ã”é€£çµ¡ãã ã•ã„ã€‚',
                'thanks': '{customer_name}æ§˜ã€æœ¬æ—¥ã¯ã”æ¥åº—ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚{service}ã®ä»•ä¸ŠãŒã‚Šã¯ã„ã‹ãŒã§ã—ã‚‡ã†ã‹ï¼Ÿã¾ãŸã®ãŠè¶Šã—ã‚’ãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™ã€‚',
                'followup': '{customer_name}æ§˜ã€å…ˆæ—¥ã¯{service}ã‚’ã”åˆ©ç”¨ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚é«ªã®èª¿å­ã¯ã„ã‹ãŒã§ã™ã‹ï¼Ÿä½•ã‹ã”è³ªå•ãŒã”ã–ã„ã¾ã—ãŸã‚‰ãŠæ°—è»½ã«ã”é€£çµ¡ãã ã•ã„ã€‚'
            };
            
            const content = templates[templateType] || '';
            document.getElementById('messageContent').value = content;
            updatePreview();
        }
        
        // Customer Display Update
        function updateSelectedCustomerDisplay() {
            const customers = {
                '1': { name: 'å±±ç”° èŠ±å­ æ§˜', phone: '090-1234-5678', service: 'ã‚«ãƒƒãƒˆ+ã‚«ãƒ©ãƒ¼' },
                '2': { name: 'ä½è—¤ ç¾å’² æ§˜', phone: '080-9876-5432', service: 'ãƒ‘ãƒ¼ãƒ+ãƒˆãƒªãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆ' },
                '3': { name: 'éˆ´æœ¨ çœŸç”±ç¾ æ§˜', phone: '070-1111-2222', service: 'ãƒ˜ãƒƒãƒ‰ã‚¹ãƒ‘+ãƒˆãƒªãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆ' }
            };
            
            const customer = customers[selectedCustomer];
            if (customer) {
                document.getElementById('selectedCustomerDisplay').innerHTML = `
                    <div>${customer.name}</div>
                    <div style="opacity: 0.8;">${customer.phone}</div>
                `;
            }
        }
        
        // Preview Update
        function updatePreview() {
            const content = document.getElementById('messageContent').value;
            const charCount = content.length;
            
            // Update character count
            document.getElementById('charCount').textContent = `${charCount}/160æ–‡å­—`;
            
            // Update preview content
            let previewContent = content || 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã™ã‚‹ã¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™';
            
            // Replace placeholders with sample data
            if (selectedCustomer) {
                const customers = {
                    '1': { name: 'å±±ç”° èŠ±å­', service: 'ã‚«ãƒƒãƒˆ+ã‚«ãƒ©ãƒ¼' },
                    '2': { name: 'ä½è—¤ ç¾å’²', service: 'ãƒ‘ãƒ¼ãƒ+ãƒˆãƒªãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆ' },
                    '3': { name: 'éˆ´æœ¨ çœŸç”±ç¾', service: 'ãƒ˜ãƒƒãƒ‰ã‚¹ãƒ‘+ãƒˆãƒªãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆ' }
                };
                const customer = customers[selectedCustomer];
                previewContent = previewContent
                    .replace(/{customer_name}/g, customer.name)
                    .replace(/{service}/g, customer.service)
                    .replace(/{date}/g, '3æœˆ16æ—¥')
                    .replace(/{time}/g, '10:00');
            }
            
            document.getElementById('previewContent').textContent = previewContent;
        }
        
        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Next buttons
            document.getElementById('nextToTemplate').addEventListener('click', function() {
                showStep('template');
            });
            
            document.getElementById('nextToCompose').addEventListener('click', function() {
                showStep('compose');
                updateSelectedCustomerDisplay();
            });
            
            // Message content change
            const messageContent = document.getElementById('messageContent');
            if (messageContent) {
                messageContent.addEventListener('input', updatePreview);
            }
            
            // Schedule timing
            document.querySelectorAll('input[name="sendTiming"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const scheduleInput = document.getElementById('scheduleInput');
                    if (this.value === 'schedule') {
                        scheduleInput.style.display = 'block';
                    } else {
                        scheduleInput.style.display = 'none';
                    }
                });
            });
            
            // Customer search
            const customerSearch = document.getElementById('customerSearch');
            if (customerSearch) {
                customerSearch.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    document.querySelectorAll('.customer-card').forEach(card => {
                        const text = card.textContent.toLowerCase();
                        if (text.includes(searchTerm)) {
                            card.style.display = 'block';
                        } else {
                            card.style.display = searchTerm ? 'none' : 'block';
                        }
                    });
                });
            }
            
            // Hover effects for cards
            document.querySelectorAll('.quick-action-card, .customer-card, .template-card').forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-2px)';
                    this.style.boxShadow = 'var(--shadow-lg)';
                });
                
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = 'var(--shadow-sm)';
                });
            });
            
            // æ¡ä»¶å¤‰æ›´æ™‚ã«å¯¾è±¡è€…æ•°ã‚’æ›´æ–°
            ['visitDateCondition', 'customerType', 'serviceType'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', updateTargetCount);
                }
            });
            
            // åˆæœŸå¯¾è±¡è€…æ•°ã‚’è¨ˆç®—
            updateTargetCount();
        });
        
        // æ¡ä»¶åˆ†ææ©Ÿèƒ½
        function updateTargetCount() {
            const visitDate = document.getElementById('visitDateCondition').value;
            const customerType = document.getElementById('customerType').value;
            const serviceType = document.getElementById('serviceType').value;
            
            targetCustomers = filterCustomers(visitDate, customerType, serviceType);
            
            const count = targetCustomers.filter(c => !excludedCustomers.has(c.id)).length;
            document.getElementById('targetCount').textContent = `${count}åãŒè©²å½“`;
            
            // æ¡ä»¶ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯æ¬¡ã¸ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            document.getElementById('nextToTemplate').disabled = count === 0;
        }
        
        function filterCustomers(visitDate, customerType, serviceType) {
            return customersDatabase.filter(customer => {
                // æ¥åº—æ—¥æ¡ä»¶
                if (visitDate !== 'any') {
                    const lastVisit = new Date(customer.lastVisit);
                    const today = new Date();
                    const diffTime = Math.abs(today - lastVisit);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    switch(visitDate) {
                        case 'today':
                            if (diffDays > 1) return false;
                            break;
                        case 'yesterday':
                            if (diffDays !== 2) return false;
                            break;
                        case 'this-week':
                            if (diffDays > 7) return false;
                            break;
                        case 'last-week':
                            if (diffDays < 7 || diffDays > 14) return false;
                            break;
                        case 'this-month':
                            if (diffDays > 30) return false;
                            break;
                    }
                }
                
                // é¡§å®¢ã‚¿ã‚¤ãƒ—æ¡ä»¶
                if (customerType !== 'any' && customer.type !== customerType) {
                    return false;
                }
                
                // æ–½è¡“ã‚¿ã‚¤ãƒ—æ¡ä»¶
                if (serviceType !== 'any') {
                    const serviceMap = {
                        'cut': 'ã‚«ãƒƒãƒˆ',
                        'color': 'ã‚«ãƒ©ãƒ¼', 
                        'perm': 'ãƒ‘ãƒ¼ãƒ',
                        'spa': 'ãƒ˜ãƒƒãƒ‰ã‚¹ãƒ‘',
                        'treatment': 'ãƒˆãƒªãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆ'
                    };
                    if (!customer.service.includes(serviceMap[serviceType])) {
                        return false;
                    }
                }
                
                return true;
            });
        }
        
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        window.previewTargets = function() {
            updateTargetCount();
            
            const modal = document.getElementById('targetPreviewModal');
            const customersList = document.getElementById('targetCustomersList');
            
            // é©ç”¨æ¡ä»¶ã‚’è¡¨ç¤º
            const conditions = [];
            const visitDate = document.getElementById('visitDateCondition').value;
            const customerType = document.getElementById('customerType').value;
            const serviceType = document.getElementById('serviceType').value;
            
            if (visitDate !== 'any') conditions.push(`æ¥åº—æ—¥: ${document.getElementById('visitDateCondition').selectedOptions[0].text}`);
            if (customerType !== 'any') conditions.push(`é¡§å®¢ã‚¿ã‚¤ãƒ—: ${document.getElementById('customerType').selectedOptions[0].text}`);
            if (serviceType !== 'any') conditions.push(`æ–½è¡“: ${document.getElementById('serviceType').selectedOptions[0].text}`);
            
            document.getElementById('appliedConditions').textContent = conditions.join(' | ') || 'æ¡ä»¶ãªã—ï¼ˆå…¨é¡§å®¢å¯¾è±¡ï¼‰';
            document.getElementById('totalTargets').textContent = `${targetCustomers.length}å`;
            
            // é¡§å®¢ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
            customersList.innerHTML = targetCustomers.map(customer => `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; border-bottom: 1px solid var(--border-color);">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="width: 40px; height: 40px; background: var(--gradient-2); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                            ${customer.name[0]}
                        </div>
                        <div>
                            <h4 style="margin: 0; color: var(--text-dark); font-size: 1rem;">${customer.name}</h4>
                            <p style="margin: 0; color: var(--text-light); font-size: 0.85rem;">${customer.phone} | ${customer.lastVisit} | ${customer.service}</p>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <span style="
                            padding: 4px 8px; 
                            border-radius: 12px; 
                            font-size: 0.8rem; 
                            background: ${getCustomerTypeColor(customer.type).bg}; 
                            color: ${getCustomerTypeColor(customer.type).text};
                        ">${getCustomerTypeLabel(customer.type)}</span>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" ${excludedCustomers.has(customer.id) ? 'checked' : ''} 
                                   onchange="toggleCustomerExclusion('${customer.id}')" />
                            <span style="font-size: 0.9rem; color: var(--text-medium);">é™¤å¤–</span>
                        </label>
                    </div>
                </div>
            `).join('');
            
            updateFinalCount();
            modal.style.display = 'flex';
        };
        
        // é¡§å®¢ã‚¿ã‚¤ãƒ—ã®è‰²åˆ†ã‘
        function getCustomerTypeColor(type) {
            const colors = {
                'vip': { bg: '#ecfdf5', text: '#065f46' },
                'regular': { bg: '#dbeafe', text: '#1e40af' },
                'new': { bg: '#fef3c7', text: '#92400e' },
                'inactive': { bg: '#fee2e2', text: '#991b1b' }
            };
            return colors[type] || { bg: '#f3f4f6', text: '#374151' };
        }
        
        function getCustomerTypeLabel(type) {
            const labels = {
                'vip': 'VIP',
                'regular': 'å¸¸é€£',
                'new': 'æ–°è¦',
                'inactive': 'ä¼‘çœ '
            };
            return labels[type] || type;
        }
        
        // å€‹åˆ¥é™¤å¤–è¨­å®š
        window.toggleCustomerExclusion = function(customerId) {
            if (excludedCustomers.has(customerId)) {
                excludedCustomers.delete(customerId);
            } else {
                excludedCustomers.add(customerId);
            }
            updateFinalCount();
            updateTargetCount(); // ãƒ¡ã‚¤ãƒ³ç”»é¢ã®å¯¾è±¡è€…æ•°ã‚‚æ›´æ–°
        };
        
        function updateFinalCount() {
            const finalCount = targetCustomers.filter(c => !excludedCustomers.has(c.id)).length;
            const finalTargetsElement = document.getElementById('finalTargets');
            if (finalTargetsElement) {
                finalTargetsElement.textContent = `${finalCount}å`;
            }
        }
        
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡
        window.closeTargetPreview = function() {
            document.getElementById('targetPreviewModal').style.display = 'none';
        };
        
        window.proceedWithTargets = function() {
            const finalCount = targetCustomers.filter(c => !excludedCustomers.has(c.id)).length;
            if (finalCount === 0) {
                alert('é€ä¿¡å¯¾è±¡è€…ãŒã„ã¾ã›ã‚“ã€‚æ¡ä»¶ã‚’è¦‹ç›´ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            closeTargetPreview();
            showStep('template');
            
            // é¸æŠã•ã‚ŒãŸé¡§å®¢ã«åŸºã¥ã„ã¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…å®¹ã‚’æ›´æ–°
            updateSelectedCustomersDisplay();
        };
    
    <script>
        // Initialize sidebar functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Mobile menu toggle
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');

            if (mobileMenuToggle) {
                mobileMenuToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('active');
                    sidebarOverlay.classList.toggle('active');
                    document.body.classList.toggle('sidebar-open');
                });
            }

            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', function() {
                    sidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('active');
                    document.body.classList.remove('sidebar-open');
                });
            }
        });
    </script>
</body>
</html>