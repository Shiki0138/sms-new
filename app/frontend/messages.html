<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>メッセージ - Salon Lumière</title>
    <link rel="stylesheet" href="/css/main-unified.css?v=20250907">
</head>
<body>
    <button class="mobile-menu-toggle" id="mobileMenuToggle">☰</button>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo-wrapper">✨</div>
            <h2 class="salon-name">Salon Lumière</h2>
            <span class="plan-badge">PREMIUM</span>
        </div>

        <nav class="nav-menu">
            <a href="/dashboard.html" class="nav-item">
                <span class="nav-icon">🏠</span>
                <span>ダッシュボード</span>
            </a>
            <a href="/appointments.html" class="nav-item">
                <span class="nav-icon">📅</span>
                <span>予約管理</span>
            </a>
            <a href="/customers.html" class="nav-item">
                <span class="nav-icon">👥</span>
                <span>顧客管理</span>
            </a>
            <a href="/messages.html" class="nav-item active">
                <span class="nav-icon">💬</span>
                <span>メッセージ</span>
            </a>
            <a href="/staff.html" class="nav-item">
                <span class="nav-icon">👨‍💼</span>
                <span>スタッフ管理</span>
            </a>
            <a href="/services.html" class="nav-item">
                <span class="nav-icon">✂️</span>
                <span>サービス管理</span>
            </a>
            <a href="/reports.html" class="nav-item">
                <span class="nav-icon">📊</span>
                <span>レポート</span>
            </a>
            <a href="/settings.html" class="nav-item">
                <span class="nav-icon">⚙️</span>
                <span>設定</span>
            </a>
        </nav>

        <div class="user-section">
            <div class="user-info">
                <div class="user-avatar">管</div>
                <div class="user-details">
                    <div class="user-name">管理者</div>
                    <div class="user-role">Administrator</div>
                </div>
            </div>
            <button class="logout-btn" id="logoutBtn">ログアウト</button>
        </div>
    </aside>

    <main class="main-content">
        <header class="header" style="background: var(--gradient-1); border-radius: 12px; margin-bottom: 1.5rem; box-shadow: var(--shadow-sm);">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div style="background: var(--primary); border-radius: 12px; padding: 12px; color: white; font-size: 1.5rem;">💬</div>
                <div>
                    <h1 class="page-title" style="margin: 0; color: var(--text-dark);">メッセージ送信</h1>
                    <p style="margin: 0; color: var(--text-light); font-size: 0.9rem;">お客様へのメッセージを送信・管理</p>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" id="historyBtn">
                    送信履歴
                </button>
                <button class="btn btn-primary" id="quickSendBtn">
                    かんたん送信
                </button>
            </div>
        </header>
        
        <div class="content-area">
            <!-- Quick Action Cards -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                <div class="quick-action-card" onclick="selectQuickAction('reminder')" style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 1.5rem;
                    border-radius: 16px;
                    cursor: pointer;
                    transition: transform 0.2s;
                    box-shadow: var(--shadow-md);
                ">
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">📅</div>
                    <h3 style="margin: 0 0 0.5rem 0; font-size: 1.1rem;">予約リマインダー</h3>
                    <p style="margin: 0; opacity: 0.9; font-size: 0.9rem;">明日の予約のお客様にリマインド</p>
                </div>
                
                <div class="quick-action-card" onclick="selectQuickAction('thanks')" style="
                    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                    color: white;
                    padding: 1.5rem;
                    border-radius: 16px;
                    cursor: pointer;
                    transition: transform 0.2s;
                    box-shadow: var(--shadow-md);
                ">
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">🙏</div>
                    <h3 style="margin: 0 0 0.5rem 0; font-size: 1.1rem;">来店お礼</h3>
                    <p style="margin: 0; opacity: 0.9; font-size: 0.9rem;">今日来店されたお客様にお礼</p>
                </div>
                
                <div class="quick-action-card" onclick="selectQuickAction('followup')" style="
                    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
                    color: white;
                    padding: 1.5rem;
                    border-radius: 16px;
                    cursor: pointer;
                    transition: transform 0.2s;
                    box-shadow: var(--shadow-md);
                ">
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">💫</div>
                    <h3 style="margin: 0 0 0.5rem 0; font-size: 1.1rem;">アフターフォロー</h3>
                    <p style="margin: 0; opacity: 0.9; font-size: 0.9rem;">施術後のお客様にフォローアップ</p>
                </div>
            </div>

            <!-- Main Message Compose Area -->
            <div class="message-compose-area" style="
                background: var(--white);
                border-radius: 16px;
                box-shadow: var(--shadow-md);
                overflow: hidden;
                border: 1px solid var(--border-color);
            ">

            <!-- Step-by-Step Message Creation -->
            <div class="message-creation-steps">
                <!-- Step 1: Customer Selection -->
                <div class="step-section active" id="step-customer" style="padding: 2rem;">
                    <div class="step-header" style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem;">
                        <div style="background: var(--primary); color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: bold;">1</div>
                        <div>
                            <h2 style="margin: 0; color: var(--text-dark); font-size: 1.3rem;">送信先のお客様を選択</h2>
                            <p style="margin: 0; color: var(--text-light); font-size: 0.9rem;">メッセージを送信するお客様を選んでください</p>
                        </div>
                    </div>
                    
                    <!-- Customer Search -->
                    <div style="margin-bottom: 1.5rem;">
                        <div style="position: relative;">
                            <input type="text" id="customerSearch" placeholder="お客様名または電話番号で検索..." style="
                                width: 100%;
                                padding: 1rem 1rem 1rem 3rem;
                                border: 2px solid var(--border-color);
                                border-radius: 12px;
                                font-size: 1rem;
                                transition: border-color 0.2s;
                            ">
                            <div style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-light); font-size: 1.2rem;">🔍</div>
                        </div>
                    </div>
                    
                    <!-- Customer Cards -->
                    <div class="customer-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        <div class="customer-card" onclick="selectCustomer('1')" style="
                            background: var(--white);
                            border: 2px solid var(--border-color);
                            border-radius: 12px;
                            padding: 1.5rem;
                            cursor: pointer;
                            transition: all 0.2s;
                            box-shadow: var(--shadow-sm);
                        ">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <div style="width: 60px; height: 60px; background: var(--gradient-2); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; font-weight: bold;">山</div>
                                <div style="flex: 1;">
                                    <h3 style="margin: 0 0 0.25rem 0; color: var(--text-dark); font-size: 1.1rem;">山田 花子 様</h3>
                                    <p style="margin: 0; color: var(--text-light); font-size: 0.9rem;">📱 090-1234-5678</p>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: var(--text-light);">
                                <span>💅 最終来店: 2024/03/10</span>
                                <span>🎨 カット+カラー</span>
                            </div>
                        </div>
                        
                        <div class="customer-card" onclick="selectCustomer('2')" style="
                            background: var(--white);
                            border: 2px solid var(--border-color);
                            border-radius: 12px;
                            padding: 1.5rem;
                            cursor: pointer;
                            transition: all 0.2s;
                            box-shadow: var(--shadow-sm);
                        ">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <div style="width: 60px; height: 60px; background: var(--gradient-2); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; font-weight: bold;">佐</div>
                                <div style="flex: 1;">
                                    <h3 style="margin: 0 0 0.25rem 0; color: var(--text-dark); font-size: 1.1rem;">佐藤 美咲 様</h3>
                                    <p style="margin: 0; color: var(--text-light); font-size: 0.9rem;">📱 080-9876-5432</p>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: var(--text-light);">
                                <span>💅 最終来店: 2024/03/08</span>
                                <span>🌊 パーマ+トリートメント</span>
                            </div>
                        </div>
                        
                        <div class="customer-card" onclick="selectCustomer('3')" style="
                            background: var(--white);
                            border: 2px solid var(--border-color);
                            border-radius: 12px;
                            padding: 1.5rem;
                            cursor: pointer;
                            transition: all 0.2s;
                            box-shadow: var(--shadow-sm);
                        ">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <div style="width: 60px; height: 60px; background: var(--gradient-2); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; font-weight: bold;">鈴</div>
                                <div style="flex: 1;">
                                    <h3 style="margin: 0 0 0.25rem 0; color: var(--text-dark); font-size: 1.1rem;">鈴木 真由美 様</h3>
                                    <p style="margin: 0; color: var(--text-light); font-size: 0.9rem;">📱 070-1111-2222</p>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: var(--text-light);">
                                <span>💅 最終来店: 2024/03/05</span>
                                <span>💆 ヘッドスパ+トリートメント</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 送信条件設定 -->
                    <div style="background: var(--gray-50); border-radius: 12px; padding: 1.5rem; margin-top: 1.5rem;">
                        <h3 style="margin: 0 0 1rem 0; color: var(--text-dark);">📋 送信条件設定</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">来店日条件</label>
                                <select id="visitDateCondition" style="width: 100%; padding: 0.5rem; border: 2px solid var(--border-color); border-radius: 8px;">
                                    <option value="any">すべて</option>
                                    <option value="today">今日来店</option>
                                    <option value="yesterday">昨日来店</option>
                                    <option value="this-week">今週来店</option>
                                    <option value="last-week">先週来店</option>
                                    <option value="this-month">今月来店</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">顧客タイプ</label>
                                <select id="customerType" style="width: 100%; padding: 0.5rem; border: 2px solid var(--border-color); border-radius: 8px;">
                                    <option value="any">すべて</option>
                                    <option value="vip">VIP顧客のみ</option>
                                    <option value="regular">常連客のみ</option>
                                    <option value="new">新規顧客のみ</option>
                                    <option value="inactive">しばらく来店なし</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">施術タイプ</label>
                                <select id="serviceType" style="width: 100%; padding: 0.5rem; border: 2px solid var(--border-color); border-radius: 8px;">
                                    <option value="any">すべて</option>
                                    <option value="cut">カット</option>
                                    <option value="color">カラー</option>
                                    <option value="perm">パーマ</option>
                                    <option value="spa">ヘッドスパ</option>
                                    <option value="treatment">トリートメント</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="background: white; border-radius: 8px; padding: 1rem; border: 2px solid var(--border-color);">
                            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 0.5rem;">
                                <span style="font-weight: 500;">送信対象者:</span>
                                <span id="targetCount" style="color: var(--primary); font-weight: bold;">0名が該当</span>
                            </div>
                            <button class="btn btn-secondary" onclick="previewTargets()" style="width: 100%;">
                                対象顧客をプレビュー
                            </button>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 1.5rem;">
                        <button class="btn btn-primary" id="nextToTemplate" style="
                            padding: 1rem 2rem;
                            font-size: 1rem;
                            border-radius: 12px;
                            display: inline-flex;
                            align-items: center;
                            gap: 0.5rem;
                        " disabled>
                            次へ：メッセージ作成 <span>→</span>
                        </button>
                    </div>
                </div>

                <!-- Step 2: Template Selection -->
                <div class="step-section" id="step-template" style="padding: 2rem; display: none;">
                    <div class="step-header" style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem;">
                        <div style="background: var(--primary); color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: bold;">2</div>
                        <div>
                            <h2 style="margin: 0; color: var(--text-dark); font-size: 1.3rem;">メッセージテンプレートを選択</h2>
                            <p style="margin: 0; color: var(--text-light); font-size: 0.9rem;">用途に合わせてテンプレートを選んでください</p>
                        </div>
                    </div>
                    
                    <!-- Template Cards -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                        <div class="template-card" onclick="selectTemplate('reminder')" style="
                            background: var(--white);
                            border: 2px solid var(--border-color);
                            border-radius: 12px;
                            padding: 1.5rem;
                            cursor: pointer;
                            transition: all 0.2s;
                            box-shadow: var(--shadow-sm);
                        ">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 12px; font-size: 1.5rem;">📅</div>
                                <div>
                                    <h3 style="margin: 0; color: var(--text-dark); font-size: 1.1rem;">予約リマインダー</h3>
                                    <p style="margin: 0; color: var(--text-light); font-size: 0.85rem;">明日の予約確認</p>
                                </div>
                            </div>
                            <div style="background: var(--gray-50); border-radius: 8px; padding: 1rem; font-size: 0.9rem; color: var(--text-medium); line-height: 1.4;">
                                "{customer_name}様、明日{date} {time}からのご予約を確認いたします。カット+カラーでお待ちしております。変更がございましたらお気軽にご連絡ください。"
                            </div>
                        </div>
                        
                        <div class="template-card" onclick="selectTemplate('thanks')" style="
                            background: var(--white);
                            border: 2px solid var(--border-color);
                            border-radius: 12px;
                            padding: 1.5rem;
                            cursor: pointer;
                            transition: all 0.2s;
                            box-shadow: var(--shadow-sm);
                        ">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 12px; padding: 12px; font-size: 1.5rem;">🙏</div>
                                <div>
                                    <h3 style="margin: 0; color: var(--text-dark); font-size: 1.1rem;">来店お礼</h3>
                                    <p style="margin: 0; color: var(--text-light); font-size: 0.85rem;">本日のご来店に感謝</p>
                                </div>
                            </div>
                            <div style="background: var(--gray-50); border-radius: 8px; padding: 1rem; font-size: 0.9rem; color: var(--text-medium); line-height: 1.4;">
                                "{customer_name}様、本日はご来店ありがとうございました。{service}の仕上がりはいかがでしょうか？またのお越しをお待ちしております。"
                            </div>
                        </div>
                        
                        <div class="template-card" onclick="selectTemplate('followup')" style="
                            background: var(--white);
                            border: 2px solid var(--border-color);
                            border-radius: 12px;
                            padding: 1.5rem;
                            cursor: pointer;
                            transition: all 0.2s;
                            box-shadow: var(--shadow-sm);
                        ">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-radius: 12px; padding: 12px; font-size: 1.5rem;">💫</div>
                                <div>
                                    <h3 style="margin: 0; color: var(--text-dark); font-size: 1.1rem;">アフターフォロー</h3>
                                    <p style="margin: 0; color: var(--text-light); font-size: 0.85rem;">施術後のフォローアップ</p>
                                </div>
                            </div>
                            <div style="background: var(--gray-50); border-radius: 8px; padding: 1rem; font-size: 0.9rem; color: var(--text-medium); line-height: 1.4;">
                                "{customer_name}様、先日は{service}をご利用いただきありがとうございました。髪の調子はいかがですか？何かご質問がございましたらお気軽にご連絡ください。"
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <button class="btn btn-secondary" onclick="goBackToCustomer()" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                            <span>←</span> 戻る
                        </button>
                        <button class="btn btn-primary" id="nextToCompose" style="
                            padding: 1rem 2rem;
                            font-size: 1rem;
                            border-radius: 12px;
                            display: inline-flex;
                            align-items: center;
                            gap: 0.5rem;
                        " disabled>
                            次へ：メッセージ編集 <span>→</span>
                        </button>
                    </div>
                </div>
                
                <!-- Step 3: Compose & Send -->
                <div class="step-section" id="step-compose" style="padding: 2rem; display: none;">
                    <div class="step-header" style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem;">
                        <div style="background: var(--primary); color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: bold;">3</div>
                        <div>
                            <h2 style="margin: 0; color: var(--text-dark); font-size: 1.3rem;">メッセージを確認・送信</h2>
                            <p style="margin: 0; color: var(--text-light); font-size: 0.9rem;">内容を確認して送信してください</p>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 300px; gap: 2rem;">
                        <!-- Message Edit Area -->
                        <div>
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-dark);">メッセージ内容</label>
                                <textarea id="messageContent" placeholder="メッセージを入力してください..." style="
                                    width: 100%;
                                    min-height: 120px;
                                    padding: 1rem;
                                    border: 2px solid var(--border-color);
                                    border-radius: 12px;
                                    font-size: 1rem;
                                    font-family: var(--font-family-primary);
                                    resize: vertical;
                                    transition: border-color 0.2s;
                                " maxlength="160"></textarea>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-light);">
                                    <span>💡 {customer_name}, {date}, {time}, {service} が使用できます</span>
                                    <span id="charCount">0/160文字</span>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-dark);">送信タイミング</label>
                                <div style="display: flex; gap: 1rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; background: var(--white);">
                                        <input type="radio" name="sendTiming" value="now" checked>
                                        <span>⚡ 今すぐ送信</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; background: var(--white);">
                                        <input type="radio" name="sendTiming" value="schedule">
                                        <span>⏰ 予約送信</span>
                                    </label>
                                </div>
                                <div id="scheduleInput" style="display: none; margin-top: 1rem;">
                                    <input type="datetime-local" id="scheduleTime" style="
                                        padding: 0.75rem;
                                        border: 2px solid var(--border-color);
                                        border-radius: 8px;
                                        font-size: 1rem;
                                    ">
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 1rem;">
                                <button class="btn btn-secondary" onclick="goBackToTemplate()" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                                    <span>←</span> 戻る
                                </button>
                                <button class="btn btn-secondary" id="saveDraftBtn" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                                    <span>💾</span> 下書き保存
                                </button>
                                <button class="btn btn-primary" id="sendMessageBtn" style="
                                    flex: 1;
                                    padding: 1rem 2rem;
                                    font-size: 1rem;
                                    border-radius: 12px;
                                    display: inline-flex;
                                    align-items: center;
                                    justify-content: center;
                                    gap: 0.5rem;
                                ">
                                    <span>📱</span> 送信する
                                </button>
                            </div>
                        </div>
                        
                        <!-- Preview Area -->
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-dark);">プレビュー</label>
                            <div style="
                                background: var(--gray-900);
                                border-radius: 24px;
                                padding: 1.5rem;
                                color: white;
                                position: relative;
                                margin-bottom: 1rem;
                            ">
                                <div style="background: var(--primary); border-radius: 18px; padding: 1rem; margin-bottom: 1rem;">
                                    <div style="font-weight: 500; margin-bottom: 0.5rem;">Salon Lumière</div>
                                    <div id="previewContent" style="line-height: 1.4; font-size: 0.95rem;">
                                        メッセージを入力するとプレビューが表示されます
                                    </div>
                                    <div style="font-size: 0.8rem; opacity: 0.8; margin-top: 0.5rem;" id="previewTime">今</div>
                                </div>
                                
                                <!-- Selected Customer Info -->
                                <div id="selectedCustomerInfo" style="
                                    background: rgba(255,255,255,0.1);
                                    border-radius: 12px;
                                    padding: 1rem;
                                    font-size: 0.9rem;
                                ">
                                    <div style="font-weight: 500; margin-bottom: 0.5rem;">送信先</div>
                                    <div id="selectedCustomerDisplay">顧客を選択してください</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    </main>
    
    <!-- モーダル -->
    <div id="modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">タイトル</h3>
                <button class="modal-close" onclick="closeModal()">×</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- モーダルコンテンツ -->
            </div>
        </div>
    </div>
    
    <!-- 対象顧客プレビューモーダル -->
    <div id="targetPreviewModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px; width: 90%;">
            <div class="modal-header">
                <h3 style="margin: 0; color: var(--text-dark);">送信対象顧客の確認・除外設定</h3>
                <button class="modal-close" onclick="closeTargetPreview()">×</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <span style="font-weight: 500; color: var(--text-dark);">適用条件:</span>
                        <span id="appliedConditions" style="color: var(--text-medium); font-size: 0.9rem;"></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>総対象者: <strong id="totalTargets">0名</strong></span>
                        <span>送信予定: <strong id="finalTargets" style="color: var(--primary);">0名</strong></span>
                    </div>
                </div>
                
                <div style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px;">
                    <div id="targetCustomersList">
                        <!-- 対象顧客リストがここに表示されます -->
                    </div>
                </div>
                
                <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-secondary" onclick="closeTargetPreview()">閉じる</button>
                        <button class="btn btn-primary" onclick="proceedWithTargets()" style="flex: 1;">
                            この条件でメッセージ作成に進む
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </main>
    
    <script>
        // デモ用の認証トークンを設定（エラー回避）
        localStorage.setItem('salon_token', 'demo_token_for_messages_page_12345678901234567890');
        localStorage.setItem('salon_user', JSON.stringify({
            id: 'demo_user',
            name: '管理者',
            email: 'admin@salon-lumiere.com',
            role: 'admin'
        }));
        
        // messages.jsの読み込みを無効化（競合回避）
        window.messagesJsDisabled = true;
    </script>
    
    <script>
        // Message Page Interactive Functionality
        let selectedCustomer = null;
        let selectedTemplate = null;
        let targetCustomers = [];
        let excludedCustomers = new Set();
        
        // サンプル顧客データ
        const customersDatabase = [
            { id: '1', name: '山田 花子', phone: '090-1234-5678', email: 'yamada@email.com', type: 'vip', lastVisit: '2024-03-14', service: 'カット+カラー' },
            { id: '2', name: '佐藤 美咲', phone: '080-9876-5432', email: 'sato@email.com', type: 'regular', lastVisit: '2024-03-13', service: 'パーマ+トリートメント' },
            { id: '3', name: '鈴木 真由美', phone: '070-1111-2222', email: 'suzuki@email.com', type: 'new', lastVisit: '2024-03-12', service: 'ヘッドスパ+トリートメント' },
            { id: '4', name: '田中 麻衣', phone: '080-7777-8888', email: 'mai@email.com', type: 'regular', lastVisit: '2024-03-15', service: 'カット' },
            { id: '5', name: '高橋 由紀', phone: '090-3333-4444', email: 'yuki@email.com', type: 'vip', lastVisit: '2024-03-14', service: 'カット+カラー+パーマ' },
            { id: '6', name: '中村 恵美', phone: '070-9999-0000', email: 'emi@email.com', type: 'inactive', lastVisit: '2023-12-20', service: 'トリートメント' }
        ];
        
        // Quick Action Functions
        window.selectQuickAction = function(type) {
            // Auto-select template based on quick action
            selectedTemplate = type;
            showStep('template');
            // Highlight the corresponding template
            setTimeout(() => {
                const templateCard = document.querySelector(`[onclick="selectTemplate('${type}')"]`);
                if (templateCard) {
                    templateCard.click();
                }
            }, 100);
        };
        
        // Customer Selection
        window.selectCustomer = function(customerId) {
            selectedCustomer = customerId;
            
            // Remove previous selection
            document.querySelectorAll('.customer-card').forEach(card => {
                card.style.border = '2px solid var(--border-color)';
                card.style.background = 'var(--white)';
            });
            
            // Highlight selected customer
            const selectedCard = document.querySelector(`[onclick="selectCustomer('${customerId}')"]`);
            selectedCard.style.border = '2px solid var(--primary)';
            selectedCard.style.background = 'var(--primary-50)';
            
            // Enable next button
            document.getElementById('nextToTemplate').disabled = false;
            
            // Update preview
            updateSelectedCustomerDisplay();
        };
        
        // Template Selection
        window.selectTemplate = function(templateType) {
            selectedTemplate = templateType;
            
            // Remove previous selection
            document.querySelectorAll('.template-card').forEach(card => {
                card.style.border = '2px solid var(--border-color)';
                card.style.background = 'var(--white)';
            });
            
            // Highlight selected template
            const selectedCard = document.querySelector(`[onclick="selectTemplate('${templateType}')"]`);
            selectedCard.style.border = '2px solid var(--primary)';
            selectedCard.style.background = 'var(--primary-50)';
            
            // Enable next button
            document.getElementById('nextToCompose').disabled = false;
            
            // Load template content
            loadTemplateContent(templateType);
        };
        
        // Step Navigation
        function showStep(stepName) {
            // Hide all steps
            document.querySelectorAll('.step-section').forEach(step => {
                step.style.display = 'none';
            });
            
            // Show selected step
            document.getElementById(`step-${stepName}`).style.display = 'block';
        }
        
        window.goBackToCustomer = function() {
            showStep('customer');
        };
        
        window.goBackToTemplate = function() {
            showStep('template');
        };
        
        // Template Content Loading
        function loadTemplateContent(templateType) {
            const templates = {
                'reminder': '{customer_name}様、明日{date} {time}からのご予約を確認いたします。カット+カラーでお待ちしております。変更がございましたらお気軽にご連絡ください。',
                'thanks': '{customer_name}様、本日はご来店ありがとうございました。{service}の仕上がりはいかがでしょうか？またのお越しをお待ちしております。',
                'followup': '{customer_name}様、先日は{service}をご利用いただきありがとうございました。髪の調子はいかがですか？何かご質問がございましたらお気軽にご連絡ください。'
            };
            
            const content = templates[templateType] || '';
            document.getElementById('messageContent').value = content;
            updatePreview();
        }
        
        // Customer Display Update
        function updateSelectedCustomerDisplay() {
            const customers = {
                '1': { name: '山田 花子 様', phone: '090-1234-5678', service: 'カット+カラー' },
                '2': { name: '佐藤 美咲 様', phone: '080-9876-5432', service: 'パーマ+トリートメント' },
                '3': { name: '鈴木 真由美 様', phone: '070-1111-2222', service: 'ヘッドスパ+トリートメント' }
            };
            
            const customer = customers[selectedCustomer];
            if (customer) {
                document.getElementById('selectedCustomerDisplay').innerHTML = `
                    <div>${customer.name}</div>
                    <div style="opacity: 0.8;">${customer.phone}</div>
                `;
            }
        }
        
        // Preview Update
        function updatePreview() {
            const content = document.getElementById('messageContent').value;
            const charCount = content.length;
            
            // Update character count
            document.getElementById('charCount').textContent = `${charCount}/160文字`;
            
            // Update preview content
            let previewContent = content || 'メッセージを入力するとプレビューが表示されます';
            
            // Replace placeholders with sample data
            if (selectedCustomer) {
                const customers = {
                    '1': { name: '山田 花子', service: 'カット+カラー' },
                    '2': { name: '佐藤 美咲', service: 'パーマ+トリートメント' },
                    '3': { name: '鈴木 真由美', service: 'ヘッドスパ+トリートメント' }
                };
                const customer = customers[selectedCustomer];
                previewContent = previewContent
                    .replace(/{customer_name}/g, customer.name)
                    .replace(/{service}/g, customer.service)
                    .replace(/{date}/g, '3月16日')
                    .replace(/{time}/g, '10:00');
            }
            
            document.getElementById('previewContent').textContent = previewContent;
        }
        
        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Next buttons
            document.getElementById('nextToTemplate').addEventListener('click', function() {
                showStep('template');
            });
            
            document.getElementById('nextToCompose').addEventListener('click', function() {
                showStep('compose');
                updateSelectedCustomerDisplay();
            });
            
            // Message content change
            const messageContent = document.getElementById('messageContent');
            if (messageContent) {
                messageContent.addEventListener('input', updatePreview);
            }
            
            // Schedule timing
            document.querySelectorAll('input[name="sendTiming"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const scheduleInput = document.getElementById('scheduleInput');
                    if (this.value === 'schedule') {
                        scheduleInput.style.display = 'block';
                    } else {
                        scheduleInput.style.display = 'none';
                    }
                });
            });
            
            // Customer search
            const customerSearch = document.getElementById('customerSearch');
            if (customerSearch) {
                customerSearch.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    document.querySelectorAll('.customer-card').forEach(card => {
                        const text = card.textContent.toLowerCase();
                        if (text.includes(searchTerm)) {
                            card.style.display = 'block';
                        } else {
                            card.style.display = searchTerm ? 'none' : 'block';
                        }
                    });
                });
            }
            
            // Hover effects for cards
            document.querySelectorAll('.quick-action-card, .customer-card, .template-card').forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-2px)';
                    this.style.boxShadow = 'var(--shadow-lg)';
                });
                
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = 'var(--shadow-sm)';
                });
            });
            
            // 条件変更時に対象者数を更新
            ['visitDateCondition', 'customerType', 'serviceType'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', updateTargetCount);
                }
            });
            
            // 初期対象者数を計算
            updateTargetCount();
        });
        
        // 条件分析機能
        function updateTargetCount() {
            const visitDate = document.getElementById('visitDateCondition').value;
            const customerType = document.getElementById('customerType').value;
            const serviceType = document.getElementById('serviceType').value;
            
            targetCustomers = filterCustomers(visitDate, customerType, serviceType);
            
            const count = targetCustomers.filter(c => !excludedCustomers.has(c.id)).length;
            document.getElementById('targetCount').textContent = `${count}名が該当`;
            
            // 条件が設定されている場合は次へボタンを有効化
            document.getElementById('nextToTemplate').disabled = count === 0;
        }
        
        function filterCustomers(visitDate, customerType, serviceType) {
            return customersDatabase.filter(customer => {
                // 来店日条件
                if (visitDate !== 'any') {
                    const lastVisit = new Date(customer.lastVisit);
                    const today = new Date();
                    const diffTime = Math.abs(today - lastVisit);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    switch(visitDate) {
                        case 'today':
                            if (diffDays > 1) return false;
                            break;
                        case 'yesterday':
                            if (diffDays !== 2) return false;
                            break;
                        case 'this-week':
                            if (diffDays > 7) return false;
                            break;
                        case 'last-week':
                            if (diffDays < 7 || diffDays > 14) return false;
                            break;
                        case 'this-month':
                            if (diffDays > 30) return false;
                            break;
                    }
                }
                
                // 顧客タイプ条件
                if (customerType !== 'any' && customer.type !== customerType) {
                    return false;
                }
                
                // 施術タイプ条件
                if (serviceType !== 'any') {
                    const serviceMap = {
                        'cut': 'カット',
                        'color': 'カラー', 
                        'perm': 'パーマ',
                        'spa': 'ヘッドスパ',
                        'treatment': 'トリートメント'
                    };
                    if (!customer.service.includes(serviceMap[serviceType])) {
                        return false;
                    }
                }
                
                return true;
            });
        }
        
        // プレビューモーダル表示
        window.previewTargets = function() {
            updateTargetCount();
            
            const modal = document.getElementById('targetPreviewModal');
            const customersList = document.getElementById('targetCustomersList');
            
            // 適用条件を表示
            const conditions = [];
            const visitDate = document.getElementById('visitDateCondition').value;
            const customerType = document.getElementById('customerType').value;
            const serviceType = document.getElementById('serviceType').value;
            
            if (visitDate !== 'any') conditions.push(`来店日: ${document.getElementById('visitDateCondition').selectedOptions[0].text}`);
            if (customerType !== 'any') conditions.push(`顧客タイプ: ${document.getElementById('customerType').selectedOptions[0].text}`);
            if (serviceType !== 'any') conditions.push(`施術: ${document.getElementById('serviceType').selectedOptions[0].text}`);
            
            document.getElementById('appliedConditions').textContent = conditions.join(' | ') || '条件なし（全顧客対象）';
            document.getElementById('totalTargets').textContent = `${targetCustomers.length}名`;
            
            // 顧客リストを表示
            customersList.innerHTML = targetCustomers.map(customer => `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; border-bottom: 1px solid var(--border-color);">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="width: 40px; height: 40px; background: var(--gradient-2); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                            ${customer.name[0]}
                        </div>
                        <div>
                            <h4 style="margin: 0; color: var(--text-dark); font-size: 1rem;">${customer.name}</h4>
                            <p style="margin: 0; color: var(--text-light); font-size: 0.85rem;">${customer.phone} | ${customer.lastVisit} | ${customer.service}</p>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <span style="
                            padding: 4px 8px; 
                            border-radius: 12px; 
                            font-size: 0.8rem; 
                            background: ${getCustomerTypeColor(customer.type).bg}; 
                            color: ${getCustomerTypeColor(customer.type).text};
                        ">${getCustomerTypeLabel(customer.type)}</span>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" ${excludedCustomers.has(customer.id) ? 'checked' : ''} 
                                   onchange="toggleCustomerExclusion('${customer.id}')" />
                            <span style="font-size: 0.9rem; color: var(--text-medium);">除外</span>
                        </label>
                    </div>
                </div>
            `).join('');
            
            updateFinalCount();
            modal.style.display = 'flex';
        };
        
        // 顧客タイプの色分け
        function getCustomerTypeColor(type) {
            const colors = {
                'vip': { bg: '#ecfdf5', text: '#065f46' },
                'regular': { bg: '#dbeafe', text: '#1e40af' },
                'new': { bg: '#fef3c7', text: '#92400e' },
                'inactive': { bg: '#fee2e2', text: '#991b1b' }
            };
            return colors[type] || { bg: '#f3f4f6', text: '#374151' };
        }
        
        function getCustomerTypeLabel(type) {
            const labels = {
                'vip': 'VIP',
                'regular': '常連',
                'new': '新規',
                'inactive': '休眠'
            };
            return labels[type] || type;
        }
        
        // 個別除外設定
        window.toggleCustomerExclusion = function(customerId) {
            if (excludedCustomers.has(customerId)) {
                excludedCustomers.delete(customerId);
            } else {
                excludedCustomers.add(customerId);
            }
            updateFinalCount();
            updateTargetCount(); // メイン画面の対象者数も更新
        };
        
        function updateFinalCount() {
            const finalCount = targetCustomers.filter(c => !excludedCustomers.has(c.id)).length;
            const finalTargetsElement = document.getElementById('finalTargets');
            if (finalTargetsElement) {
                finalTargetsElement.textContent = `${finalCount}名`;
            }
        }
        
        // プレビューモーダル制御
        window.closeTargetPreview = function() {
            document.getElementById('targetPreviewModal').style.display = 'none';
        };
        
        window.proceedWithTargets = function() {
            const finalCount = targetCustomers.filter(c => !excludedCustomers.has(c.id)).length;
            if (finalCount === 0) {
                alert('送信対象者がいません。条件を見直してください。');
                return;
            }
            
            closeTargetPreview();
            showStep('template');
            
            // 選択された顧客に基づいてテンプレート内容を更新
            updateSelectedCustomersDisplay();
        };
    
    <script>
        // Initialize sidebar functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Mobile menu toggle
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');

            if (mobileMenuToggle) {
                mobileMenuToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('active');
                    sidebarOverlay.classList.toggle('active');
                    document.body.classList.toggle('sidebar-open');
                });
            }

            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', function() {
                    sidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('active');
                    document.body.classList.remove('sidebar-open');
                });
            }
        });
    </script>
</body>
</html>