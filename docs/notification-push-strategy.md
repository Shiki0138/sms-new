# é€šçŸ¥ãƒ»ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥æˆ¦ç•¥è¨­è¨ˆæ›¸

## ğŸ“² é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦

### é€šçŸ¥ã‚¿ã‚¤ãƒ—åˆ†é¡
```
ğŸ“± ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ (PWA)
â”œâ”€â”€ ğŸ“… äºˆç´„é–¢é€£é€šçŸ¥
â”‚   â”œâ”€â”€ äºˆç´„ç¢ºèª
â”‚   â”œâ”€â”€ ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼
â”‚   â”œâ”€â”€ ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ»å¤‰æ›´
â”‚   â””â”€â”€ å½“æ—¥ç¢ºèª
â”œâ”€â”€ ğŸ’ ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°é€šçŸ¥  
â”‚   â”œâ”€â”€ ç‰¹åˆ¥ã‚ªãƒ•ã‚¡ãƒ¼
â”‚   â”œâ”€â”€ æ–°ã‚µãƒ¼ãƒ“ã‚¹
â”‚   â”œâ”€â”€ èª•ç”Ÿæ—¥ç‰¹å…¸
â”‚   â””â”€â”€ ãƒ­ã‚¤ãƒ¤ãƒ«ãƒ†ã‚£
â”œâ”€â”€ âš¡ ç·Šæ€¥é€šçŸ¥
â”‚   â”œâ”€â”€ äºˆç´„å¤‰æ›´è¦è«‹
â”‚   â”œâ”€â”€ å¤©å€™ãƒ»ç½å®³
â”‚   â””â”€â”€ ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹
â””â”€â”€ ğŸ¯ ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«é€šçŸ¥
    â”œâ”€â”€ æ–½è¡“å®Œäº†
    â”œâ”€â”€ æ¬¡å›äºˆç´„ææ¡ˆ
    â”œâ”€â”€ ã‚¢ãƒ—ãƒªæ›´æ–°
    â””â”€â”€ è©•ä¾¡ãƒ»ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¾é ¼
```

---

## ğŸ¯ é€šçŸ¥æˆ¦ç•¥ãƒãƒˆãƒªã‚¯ã‚¹

### å„ªå…ˆåº¦ãƒ»ã‚¿ã‚¤ãƒŸãƒ³ã‚°è¨­è¨ˆ

| é€šçŸ¥ã‚¿ã‚¤ãƒ— | å„ªå…ˆåº¦ | é…ä¿¡ã‚¿ã‚¤ãƒŸãƒ³ã‚° | é »åº¦åˆ¶é™ | ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚º |
|-----------|-------|---------------|----------|--------------|
| äºˆç´„ç¢ºèª | ğŸ”´ é«˜ | å³åº§ | - | é«˜ |
| 24hå‰ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ | ğŸ”´ é«˜ | 24æ™‚é–“å‰ | 1å› | é«˜ |
| 2hå‰ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ | ğŸŸ  ä¸­ | 2æ™‚é–“å‰ | 1å› | é«˜ |
| ç‰¹åˆ¥ã‚ªãƒ•ã‚¡ãƒ¼ | ğŸŸ¡ ä½ | å–¶æ¥­æ™‚é–“å†… | é€±1å›ã¾ã§ | ä¸­ |
| èª•ç”Ÿæ—¥ç‰¹å…¸ | ğŸ”´ é«˜ | èª•ç”Ÿæ—¥1é€±é–“å‰ | å¹´1å› | é«˜ |
| æ–°ã‚µãƒ¼ãƒ“ã‚¹ | ğŸŸ¡ ä½ | å¹³æ—¥10-18æ™‚ | æœˆ2å›ã¾ã§ | ä¸­ |
| æ–½è¡“å®Œäº† | ğŸŸ  ä¸­ | æ–½è¡“çµ‚äº†å¾Œ | - | é«˜ |
| ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¾é ¼ | ğŸŸ¡ ä½ | æ–½è¡“24æ™‚é–“å¾Œ | - | ä½ |

---

## ğŸ“… äºˆç´„é–¢é€£é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 

### 1. äºˆç´„ç¢ºèªé€šçŸ¥

#### é€šçŸ¥å†…å®¹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
```json
{
  "type": "appointment_confirmed",
  "title": "âœ… äºˆç´„ãŒç¢ºå®šã—ã¾ã—ãŸ",
  "body": "12æœˆ13æ—¥(é‡‘) 14:00ã‹ã‚‰ã®ã”äºˆç´„ã‚’æ‰¿ã‚Šã¾ã—ãŸ",
  "data": {
    "appointmentId": "apt_123456",
    "date": "2024-12-13",
    "time": "14:00",
    "services": ["ã‚«ãƒƒãƒˆ", "ã‚«ãƒ©ãƒ¼"],
    "staff": "å±±ç”°ç¾å’²",
    "total": 8650,
    "action": "view_appointment"
  },
  "actions": [
    {
      "action": "view",
      "title": "è©³ç´°ã‚’è¦‹ã‚‹",
      "icon": "/icons/view.png"
    },
    {
      "action": "calendar",
      "title": "ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è¿½åŠ ",
      "icon": "/icons/calendar.png"
    }
  ],
  "scheduling": {
    "immediate": true,
    "badge": true,
    "sound": "default",
    "vibrate": [100, 50, 100]
  }
}
```

#### å®Ÿè£…ã‚³ãƒ¼ãƒ‰
```javascript
// äºˆç´„ç¢ºèªé€šçŸ¥ã®é€ä¿¡
class AppointmentNotificationService {
  async sendConfirmationNotification(appointment) {
    const notification = {
      title: 'âœ… äºˆç´„ãŒç¢ºå®šã—ã¾ã—ãŸ',
      body: this.formatConfirmationMessage(appointment),
      icon: '/icons/appointment-confirmed.png',
      badge: '/icons/badge.png',
      tag: `appointment-${appointment.id}`,
      data: {
        type: 'appointment_confirmed',
        appointmentId: appointment.id,
        url: `/appointments/${appointment.id}`
      },
      actions: [
        {
          action: 'view',
          title: 'è©³ç´°ã‚’è¦‹ã‚‹',
          icon: '/icons/action-view.png'
        },
        {
          action: 'calendar',
          title: 'ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è¿½åŠ ',
          icon: '/icons/action-calendar.png'
        }
      ],
      requireInteraction: false,
      silent: false,
      vibrate: [200, 100, 200]
    };

    // ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥é€ä¿¡
    if ('serviceWorker' in navigator) {
      const registration = await navigator.serviceWorker.ready;
      await registration.showNotification(notification.title, notification);
    }

    // ãƒãƒƒã‚¸æ›´æ–°
    await this.updateBadgeCount();
    
    // åˆ†æãƒ‡ãƒ¼ã‚¿é€ä¿¡
    this.trackNotificationSent('appointment_confirmed', appointment.id);
  }

  formatConfirmationMessage(appointment) {
    const date = new Date(appointment.appointmentDate).toLocaleDateString('ja-JP', {
      month: 'long',
      day: 'numeric',
      weekday: 'short'
    });
    
    const time = appointment.startTime;
    const staff = appointment.staff?.name || '';
    
    return `${date} ${time}ã‹ã‚‰ã®ã”äºˆç´„ã‚’æ‰¿ã‚Šã¾ã—ãŸ${staff ? ` (æ‹…å½“: ${staff})` : ''}`;
  }
}
```

### 2. ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 

#### å¤šæ®µéšãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼è¨­è¨ˆ
```javascript
// ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼é€šçŸ¥ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°
class ReminderScheduler {
  constructor() {
    this.reminderTypes = [
      {
        name: '24h_before',
        offset: 24 * 60 * 60 * 1000, // 24æ™‚é–“å‰
        priority: 'high',
        title: 'ğŸ“… æ˜æ—¥ã®ã”äºˆç´„ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼',
        template: 'tomorrow_reminder'
      },
      {
        name: '2h_before', 
        offset: 2 * 60 * 60 * 1000, // 2æ™‚é–“å‰
        priority: 'high',
        title: 'â° ã¾ã‚‚ãªãã”äºˆç´„æ™‚é–“ã§ã™',
        template: 'soon_reminder'
      },
      {
        name: '30min_before',
        offset: 30 * 60 * 1000, // 30åˆ†å‰
        priority: 'urgent',
        title: 'ğŸš¶â€â™€ï¸ ãã‚ãã‚ãŠå‡ºã‹ã‘ãã ã•ã„',
        template: 'departure_reminder'
      }
    ];
  }

  async scheduleReminders(appointment) {
    for (const reminder of this.reminderTypes) {
      const reminderTime = new Date(appointment.appointmentDate).getTime() - reminder.offset;
      const now = Date.now();

      if (reminderTime > now) {
        await this.scheduleNotification(appointment, reminder, reminderTime);
      }
    }
  }

  async scheduleNotification(appointment, reminder, scheduledTime) {
    const notificationData = {
      appointmentId: appointment.id,
      reminderType: reminder.name,
      scheduledTime,
      title: reminder.title,
      body: this.generateReminderBody(appointment, reminder.template),
      data: {
        type: 'appointment_reminder',
        appointmentId: appointment.id,
        reminderType: reminder.name,
        url: `/appointments/${appointment.id}`
      },
      actions: this.getReminderActions(reminder.name)
    };

    // Service WorkerçµŒç”±ã§ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
    if ('serviceWorker' in navigator) {
      const registration = await navigator.serviceWorker.ready;
      registration.sync.register(`reminder-${appointment.id}-${reminder.name}`);
    }

    // ä»£æ›¿ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ï¼ˆsetTimeoutï¼‰
    const delay = scheduledTime - Date.now();
    if (delay > 0 && delay < 2147483647) { // setTimeoutåˆ¶é™å†…
      setTimeout(() => {
        this.sendReminderNotification(notificationData);
      }, delay);
    }
  }

  generateReminderBody(appointment, template) {
    const templates = {
      tomorrow_reminder: (apt) => 
        `æ˜æ—¥ ${apt.startTime}ã‹ã‚‰ã‚«ãƒƒãƒˆãƒ»ã‚«ãƒ©ãƒ¼ã®ã”äºˆç´„ãŒã‚ã‚Šã¾ã™ã€‚ãŠæ°—ã‚’ã¤ã‘ã¦ãŠè¶Šã—ãã ã•ã„ã€‚`,
      
      soon_reminder: (apt) => 
        `${apt.startTime}ã‹ã‚‰ã®ã”äºˆç´„ã¾ã§ã‚ã¨2æ™‚é–“ã§ã™ã€‚æº–å‚™ã¯ãŠæ¸ˆã¿ã§ã™ã‹ï¼Ÿ`,
      
      departure_reminder: (apt) => 
        `${apt.startTime}ã‹ã‚‰ã®ã”äºˆç´„ã¾ã§30åˆ†ã§ã™ã€‚ãã‚ãã‚ãŠå‡ºã‹ã‘ãã ã•ã„ã€‚`
    };

    return templates[template]?.(appointment) || `ã”äºˆç´„ã®ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã§ã™`;
  }

  getReminderActions(reminderType) {
    const baseActions = [
      {
        action: 'view',
        title: 'è©³ç´°ç¢ºèª',
        icon: '/icons/action-view.png'
      }
    ];

    switch (reminderType) {
      case '24h_before':
        return [
          ...baseActions,
          {
            action: 'reschedule',
            title: 'å¤‰æ›´ã™ã‚‹',
            icon: '/icons/action-reschedule.png'
          },
          {
            action: 'directions',
            title: 'é“é †ã‚’è¦‹ã‚‹',
            icon: '/icons/action-directions.png'
          }
        ];

      case '2h_before':
        return [
          ...baseActions,
          {
            action: 'directions',
            title: 'é“é †ã‚’è¦‹ã‚‹',
            icon: '/icons/action-directions.png'
          },
          {
            action: 'call',
            title: 'ã‚µãƒ­ãƒ³ã«é›»è©±',
            icon: '/icons/action-call.png'
          }
        ];

      case '30min_before':
        return [
          {
            action: 'directions',
            title: 'é“é †ã‚’è¦‹ã‚‹',
            icon: '/icons/action-directions.png'
          },
          {
            action: 'call',
            title: 'é›»è©±ã™ã‚‹',
            icon: '/icons/action-call.png'
          }
        ];

      default:
        return baseActions;
    }
  }
}
```

---

## ğŸ ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°é€šçŸ¥æˆ¦ç•¥

### 1. ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºãƒ‰ã‚ªãƒ•ã‚¡ãƒ¼

```javascript
// å€‹äººå‘ã‘ã‚ªãƒ•ã‚¡ãƒ¼é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
class PersonalizedOfferSystem {
  constructor() {
    this.offerTypes = {
      birthday: {
        trigger: 'birthday_week',
        title: 'ğŸ‚ ãŠèª•ç”Ÿæ—¥ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼',
        discount: 0.2,
        validDays: 30
      },
      loyalty: {
        trigger: 'visit_milestone',
        title: 'ğŸ‘‘ VIPç‰¹å…¸ã®ã”æ¡ˆå†…',
        discount: 0.15,
        validDays: 14
      },
      seasonal: {
        trigger: 'season_change',
        title: 'ğŸŒ¸ å­£ç¯€é™å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã”æ¡ˆå†…',
        discount: 0.1,
        validDays: 21
      },
      winback: {
        trigger: 'long_absence',
        title: 'ğŸ’Œ ãŠä¹…ã—ã¶ã‚Šã§ã™ï¼ã‚«ãƒ ãƒãƒƒã‚¯ç‰¹å…¸',
        discount: 0.25,
        validDays: 14
      }
    };
  }

  async evaluateOfferEligibility(customerId) {
    const customer = await this.getCustomerData(customerId);
    const eligibleOffers = [];

    // èª•ç”Ÿæ—¥ç‰¹å…¸ãƒã‚§ãƒƒã‚¯
    if (this.isBirthdayWeek(customer.birthDate)) {
      eligibleOffers.push({
        type: 'birthday',
        ...this.offerTypes.birthday,
        personalization: {
          name: customer.firstName,
          favoriteServices: customer.preferences.services,
          lastVisit: customer.lastVisit
        }
      });
    }

    // ãƒ­ã‚¤ãƒ¤ãƒ«ãƒ†ã‚£ç‰¹å…¸ãƒã‚§ãƒƒã‚¯
    if (this.checkLoyaltyMilestone(customer)) {
      eligibleOffers.push({
        type: 'loyalty',
        ...this.offerTypes.loyalty,
        personalization: {
          visitCount: customer.visitCount,
          totalSpent: customer.totalSpent
        }
      });
    }

    // é›¢è„±é˜²æ­¢ç‰¹å…¸ãƒã‚§ãƒƒã‚¯
    const daysSinceLastVisit = this.daysSince(customer.lastVisit);
    if (daysSinceLastVisit > 90) {
      eligibleOffers.push({
        type: 'winback',
        ...this.offerTypes.winback,
        personalization: {
          lastVisit: customer.lastVisit,
          missedSeasons: Math.floor(daysSinceLastVisit / 90)
        }
      });
    }

    return eligibleOffers;
  }

  async sendPersonalizedOffer(customerId, offer) {
    const notification = {
      title: offer.title,
      body: this.generateOfferBody(offer),
      icon: '/icons/offer.png',
      badge: '/icons/badge.png',
      tag: `offer-${offer.type}-${customerId}`,
      data: {
        type: 'marketing_offer',
        offerType: offer.type,
        customerId,
        discount: offer.discount,
        validUntil: this.calculateValidUntil(offer.validDays),
        url: `/offers/${offer.type}`
      },
      actions: [
        {
          action: 'book',
          title: 'ä»Šã™ãäºˆç´„',
          icon: '/icons/action-book.png'
        },
        {
          action: 'view',
          title: 'è©³ç´°ã‚’è¦‹ã‚‹',
          icon: '/icons/action-view.png'
        }
      ],
      requireInteraction: true,
      silent: false
    };

    // é…ä¿¡æ™‚é–“æœ€é©åŒ–
    const optimalTime = await this.calculateOptimalDeliveryTime(customerId);
    await this.scheduleNotification(notification, optimalTime);
  }

  generateOfferBody(offer) {
    const discount = Math.floor(offer.discount * 100);
    
    switch (offer.type) {
      case 'birthday':
        return `ç‰¹åˆ¥ãªæ—¥ã«${discount}%OFFã§ã‚­ãƒ¬ã‚¤ã«ãªã‚Šã¾ã›ã‚“ã‹ï¼Ÿæœ‰åŠ¹æœŸé™: ${offer.validDays}æ—¥é–“`;
      
      case 'loyalty':
        return `ã„ã¤ã‚‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼VIPé™å®š${discount}%OFFã‚’ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆ`;
      
      case 'seasonal':
        return `ã“ã®å­£ç¯€ã ã‘ã®é™å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒ${discount}%OFFã§ãŠè©¦ã—ã„ãŸã ã‘ã¾ã™`;
      
      case 'winback':
        return `ãŠä¹…ã—ã¶ã‚Šã§ã™ï¼ã‚«ãƒ ãƒãƒƒã‚¯è¨˜å¿µã§${discount}%OFFã‚’ã”ç”¨æ„ã—ã¾ã—ãŸ`;
      
      default:
        return `ç‰¹åˆ¥ä¾¡æ ¼${discount}%OFFã§ã”æä¾›ä¸­ã§ã™`;
    }
  }
}
```

### 2. é…ä¿¡æ™‚é–“æœ€é©åŒ–

```javascript
// é…ä¿¡æ™‚é–“æœ€é©åŒ–ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
class DeliveryOptimization {
  async calculateOptimalDeliveryTime(customerId) {
    // é¡§å®¢ã®è¡Œå‹•ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ
    const behaviorData = await this.getCustomerBehavior(customerId);
    const preferences = await this.getNotificationPreferences(customerId);
    
    // æœ€é©é…ä¿¡æ™‚é–“ã®è¨ˆç®—
    const optimalHours = this.analyzeEngagementPatterns(behaviorData);
    const preferredTimeZone = preferences.timeZone || 'Asia/Tokyo';
    
    // ç¾åœ¨æ™‚åˆ»ã¨ã®èª¿æ•´
    const now = new Date();
    const nextOptimalSlot = this.findNextOptimalSlot(now, optimalHours, preferredTimeZone);
    
    return nextOptimalSlot;
  }

  analyzeEngagementPatterns(behaviorData) {
    const hourlyEngagement = new Array(24).fill(0);
    
    // éå»ã®é€šçŸ¥é–‹å°ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æ
    behaviorData.notificationClicks.forEach(click => {
      const hour = new Date(click.timestamp).getHours();
      hourlyEngagement[hour]++;
    });

    // ã‚¢ãƒ—ãƒªåˆ©ç”¨æ™‚é–“ã‚‚è€ƒæ…®
    behaviorData.appSessions.forEach(session => {
      const startHour = new Date(session.startTime).getHours();
      const endHour = new Date(session.endTime).getHours();
      
      for (let hour = startHour; hour <= endHour; hour++) {
        hourlyEngagement[hour] += 0.5;
      }
    });

    // ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆã®é«˜ã„ä¸Šä½3æ™‚é–“ã‚’è¿”ã™
    return hourlyEngagement
      .map((engagement, hour) => ({ hour, engagement }))
      .sort((a, b) => b.engagement - a.engagement)
      .slice(0, 3)
      .map(item => item.hour);
  }

  findNextOptimalSlot(currentTime, optimalHours, timeZone) {
    const optimal = optimalHours[0]; // æœ€ã‚‚ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆã®é«˜ã„æ™‚é–“
    const today = new Date(currentTime);
    
    // ä»Šæ—¥ã®æœ€é©æ™‚é–“
    const todayOptimal = new Date(today);
    todayOptimal.setHours(optimal, 0, 0, 0);
    
    // æ—¢ã«éãã¦ã„ã‚‹å ´åˆã¯ç¿Œæ—¥
    if (todayOptimal <= currentTime) {
      todayOptimal.setDate(todayOptimal.getDate() + 1);
    }
    
    // å–¶æ¥­æ—¥ãƒ»å–¶æ¥­æ™‚é–“ãƒã‚§ãƒƒã‚¯
    if (!this.isBusinessDay(todayOptimal) || !this.isBusinessHour(optimal)) {
      return this.findNextBusinessSlot(todayOptimal, optimalHours);
    }
    
    return todayOptimal;
  }
}
```

---

## âš¡ ç·Šæ€¥é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 

### 1. ç·Šæ€¥åº¦åˆ†é¡

```javascript
// ç·Šæ€¥é€šçŸ¥ã®å„ªå…ˆåº¦åˆ¶å¾¡
class EmergencyNotificationSystem {
  constructor() {
    this.emergencyLevels = {
      critical: {
        priority: 1,
        sound: 'critical_alert.mp3',
        vibrate: [500, 250, 500, 250, 500],
        requireInteraction: true,
        showToUser: true,
        bypassDoNotDisturb: true
      },
      high: {
        priority: 2,
        sound: 'high_priority.mp3',
        vibrate: [300, 200, 300],
        requireInteraction: true,
        showToUser: true,
        bypassDoNotDisturb: false
      },
      medium: {
        priority: 3,
        sound: 'default',
        vibrate: [200, 100, 200],
        requireInteraction: false,
        showToUser: true,
        bypassDoNotDisturb: false
      }
    };
  }

  async sendEmergencyNotification(type, data, level = 'medium') {
    const config = this.emergencyLevels[level];
    
    const notification = {
      title: this.getEmergencyTitle(type),
      body: this.getEmergencyBody(type, data),
      icon: '/icons/emergency.png',
      badge: '/icons/badge.png',
      tag: `emergency-${type}-${Date.now()}`,
      data: {
        type: 'emergency',
        subType: type,
        level,
        timestamp: new Date().toISOString(),
        ...data
      },
      ...config
    };

    // å³åº§ã«é€ä¿¡
    if ('serviceWorker' in navigator) {
      const registration = await navigator.serviceWorker.ready;
      await registration.showNotification(notification.title, notification);
    }

    // ãƒ­ã‚°è¨˜éŒ²
    this.logEmergencyNotification(type, level, data);
  }

  getEmergencyTitle(type) {
    const titles = {
      appointment_cancelled: 'âš ï¸ ã”äºˆç´„ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ',
      schedule_change: 'ğŸ“… äºˆç´„æ™‚é–“ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸ',
      weather_alert: 'ğŸŒ§ï¸ æ‚ªå¤©å€™ã®ãŠçŸ¥ã‚‰ã›',
      system_maintenance: 'ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹',
      staff_absence: 'ğŸ‘¤ æ‹…å½“è€…å¤‰æ›´ã®ãŠçŸ¥ã‚‰ã›'
    };
    
    return titles[type] || 'âš ï¸ é‡è¦ãªãŠçŸ¥ã‚‰ã›';
  }

  getEmergencyBody(type, data) {
    switch (type) {
      case 'appointment_cancelled':
        return `${data.date} ${data.time}ã®ã”äºˆç´„ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚åˆ¥ã®æ—¥ç¨‹ã‚’ã”ææ¡ˆã„ãŸã—ã¾ã™ã€‚`;
      
      case 'schedule_change':
        return `ã”äºˆç´„æ™‚é–“ãŒ${data.newTime}ã«å¤‰æ›´ã•ã‚Œã¾ã—ãŸã€‚ã”éƒ½åˆãŒæ‚ªã„å ´åˆã¯ãŠçŸ¥ã‚‰ã›ãã ã•ã„ã€‚`;
      
      case 'weather_alert':
        return `æ‚ªå¤©å€™ã®ãŸã‚ã€ã”æ¥åº—æ™‚ã¯ãŠæ°—ã‚’ã¤ã‘ãã ã•ã„ã€‚å¤‰æ›´ã‚’ã”å¸Œæœ›ã®å ´åˆã¯ã”é€£çµ¡ãã ã•ã„ã€‚`;
      
      case 'system_maintenance':
        return `${data.startTime}ã€œ${data.endTime}ã®é–“ã€ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚’å®Ÿæ–½ã„ãŸã—ã¾ã™ã€‚`;
      
      case 'staff_absence':
        return `æ‹…å½“ã®${data.originalStaff}ãŒæ€¥é½ãŠä¼‘ã¿ã¨ãªã‚Šã€${data.newStaff}ãŒæ‹…å½“ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚`;
      
      default:
        return 'ã‚µãƒ­ãƒ³ã‹ã‚‰ã®é‡è¦ãªãŠçŸ¥ã‚‰ã›ãŒã‚ã‚Šã¾ã™ã€‚';
    }
  }
}
```

---

## ğŸ“Š é€šçŸ¥åŠ¹æœæ¸¬å®šãƒ»æœ€é©åŒ–

### 1. åˆ†æã‚·ã‚¹ãƒ†ãƒ 

```javascript
// é€šçŸ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ
class NotificationAnalytics {
  constructor() {
    this.metrics = {
      sent: 0,
      delivered: 0,
      opened: 0,
      clicked: 0,
      converted: 0
    };
  }

  async trackNotificationMetrics(notificationId, event, data = {}) {
    const metric = {
      notificationId,
      event,
      timestamp: new Date().toISOString(),
      userAgent: navigator.userAgent,
      ...data
    };

    // ãƒ­ãƒ¼ã‚«ãƒ«åˆ†æãƒ‡ãƒ¼ã‚¿ã«è¨˜éŒ²
    await this.storeMetric(metric);
    
    // ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ï¼ˆãƒãƒƒãƒå‡¦ç†ï¼‰
    await this.queueForServerAnalysis(metric);
  }

  async generatePerformanceReport(timeRange = '30d') {
    const metrics = await this.getMetrics(timeRange);
    
    return {
      overview: {
        totalSent: metrics.length,
        deliveryRate: this.calculateRate(metrics, 'delivered', 'sent'),
        openRate: this.calculateRate(metrics, 'opened', 'delivered'),
        clickRate: this.calculateRate(metrics, 'clicked', 'opened'),
        conversionRate: this.calculateRate(metrics, 'converted', 'clicked')
      },
      byType: this.analyzeByNotificationType(metrics),
      byTime: this.analyzeByTimeOfDay(metrics),
      recommendations: this.generateRecommendations(metrics)
    };
  }

  generateRecommendations(metrics) {
    const recommendations = [];
    
    // é–‹å°ç‡ãŒä½ã„é€šçŸ¥ã‚¿ã‚¤ãƒ—ã®ç‰¹å®š
    const lowPerformingTypes = this.identifyLowPerformingTypes(metrics);
    if (lowPerformingTypes.length > 0) {
      recommendations.push({
        type: 'content_optimization',
        priority: 'high',
        message: `${lowPerformingTypes.join(', ')}ã®é€šçŸ¥å†…å®¹ã‚’è¦‹ç›´ã—ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™`,
        impact: 'medium'
      });
    }

    // æœ€é©é…ä¿¡æ™‚é–“ã®ææ¡ˆ
    const optimalTimes = this.findOptimalDeliveryTimes(metrics);
    recommendations.push({
      type: 'timing_optimization',
      priority: 'medium',
      message: `${optimalTimes.join('æ™‚ã€')}æ™‚é ƒã®é…ä¿¡ã§é–‹å°ç‡ãŒå‘ä¸Šã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™`,
      impact: 'high'
    });

    return recommendations;
  }
}
```

### 2. A/Bãƒ†ã‚¹ãƒˆå®Ÿè£…

```javascript
// é€šçŸ¥A/Bãƒ†ã‚¹ãƒˆ
class NotificationABTest {
  constructor() {
    this.activeTests = new Map();
  }

  async createABTest(testConfig) {
    const test = {
      id: this.generateTestId(),
      name: testConfig.name,
      variants: testConfig.variants,
      trafficSplit: testConfig.trafficSplit || [50, 50],
      startDate: new Date(),
      endDate: new Date(Date.now() + testConfig.duration),
      metrics: ['open_rate', 'click_rate', 'conversion_rate'],
      status: 'active'
    };

    this.activeTests.set(test.id, test);
    return test;
  }

  async getVariantForUser(testId, userId) {
    const test = this.activeTests.get(testId);
    if (!test || test.status !== 'active') {
      return null;
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãƒ™ãƒ¼ã‚¹ã®ä¸€è²«ã—ãŸå‰²ã‚ŠæŒ¯ã‚Š
    const hash = this.hashUserId(userId);
    const splitPoint = test.trafficSplit[0];
    
    return hash % 100 < splitPoint ? test.variants[0] : test.variants[1];
  }

  async sendTestNotification(testId, userId, baseNotification) {
    const variant = await this.getVariantForUser(testId, userId);
    if (!variant) {
      return this.sendStandardNotification(baseNotification);
    }

    const notification = {
      ...baseNotification,
      title: variant.title || baseNotification.title,
      body: variant.body || baseNotification.body,
      icon: variant.icon || baseNotification.icon,
      data: {
        ...baseNotification.data,
        abTest: {
          testId,
          variantId: variant.id
        }
      }
    };

    await this.sendNotification(notification);
    await this.trackTestMetric(testId, variant.id, 'sent', userId);
  }

  async analyzeTestResults(testId) {
    const test = this.activeTests.get(testId);
    const results = await this.getTestMetrics(testId);
    
    const analysis = {
      testId,
      testName: test.name,
      duration: Date.now() - test.startDate.getTime(),
      variants: test.variants.map(variant => ({
        ...variant,
        metrics: this.calculateVariantMetrics(results, variant.id),
        significance: this.calculateStatisticalSignificance(results, variant.id)
      })),
      conclusion: this.generateConclusion(results),
      recommendation: this.generateRecommendation(results)
    };

    return analysis;
  }
}
```

---

## ğŸ”§ å®Ÿè£…ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### 1. é€šçŸ¥æ¨©é™ç®¡ç†

```javascript
// é€šçŸ¥æ¨©é™ã®é©åˆ‡ãªç®¡ç†
class NotificationPermissionManager {
  async requestPermissionGradually() {
    // æ®µéšçš„ãªãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³è¦æ±‚
    const strategies = [
      this.showEducationalModal,
      this.offerIncentive,
      this.requestAtOptimalMoment
    ];

    for (const strategy of strategies) {
      const result = await strategy();
      if (result === 'granted') {
        return result;
      }
      
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‹’å¦ã—ãŸå ´åˆã¯æ¬¡ã®æˆ¦ç•¥ã‚’è©¦ã•ãªã„
      if (result === 'denied') {
        break;
      }
    }

    return Notification.permission;
  }

  async showEducationalModal() {
    return new Promise((resolve) => {
      const modal = this.createEducationalModal();
      modal.onAccept = async () => {
        const permission = await Notification.requestPermission();
        resolve(permission);
      };
      modal.onDecline = () => resolve('default');
      modal.show();
    });
  }

  createEducationalModal() {
    // é€šçŸ¥ã®ä¾¡å€¤ã‚’èª¬æ˜ã™ã‚‹ãƒ¢ãƒ¼ãƒ€ãƒ«å®Ÿè£…
    return {
      title: 'ğŸ“± é€šçŸ¥ã§ã‚‚ã£ã¨ä¾¿åˆ©ã«',
      content: `
        â€¢ äºˆç´„ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã§å¿˜ã‚Œé˜²æ­¢
        â€¢ ç‰¹åˆ¥ã‚ªãƒ•ã‚¡ãƒ¼ã‚’è¦‹é€ƒã•ãªã„  
        â€¢ ç·Šæ€¥æ™‚ã®é‡è¦ãªãŠçŸ¥ã‚‰ã›
      `,
      benefits: [
        'äºˆç´„ã®å¿˜ã‚Œé˜²æ­¢',
        'ãŠå¾—ãªæƒ…å ±ã‚’ãŠå±Šã‘',
        'ç·Šæ€¥æ™‚ã®ãŠçŸ¥ã‚‰ã›'
      ]
    };
  }
}
```

### 2. ãƒãƒƒãƒ†ãƒªãƒ¼ãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹é…æ…®

```javascript
// ãƒãƒƒãƒ†ãƒªãƒ¼åŠ¹ç‡ã‚’è€ƒæ…®ã—ãŸé€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
class BatteryAwareNotifications {
  constructor() {
    this.batteryLevel = 1.0;
    this.isCharging = false;
    this.setupBatteryMonitoring();
  }

  async setupBatteryMonitoring() {
    if ('getBattery' in navigator) {
      const battery = await navigator.getBattery();
      
      this.batteryLevel = battery.level;
      this.isCharging = battery.charging;
      
      battery.addEventListener('levelchange', () => {
        this.batteryLevel = battery.level;
        this.adjustNotificationStrategy();
      });
      
      battery.addEventListener('chargingchange', () => {
        this.isCharging = battery.charging;
        this.adjustNotificationStrategy();
      });
    }
  }

  adjustNotificationStrategy() {
    if (this.batteryLevel < 0.2 && !this.isCharging) {
      // ä½ãƒãƒƒãƒ†ãƒªãƒ¼æ™‚ã¯é‡è¦ãªé€šçŸ¥ã®ã¿
      this.notificationStrategy = 'critical_only';
      this.vibrationEnabled = false;
      this.soundEnabled = false;
    } else if (this.batteryLevel < 0.5 && !this.isCharging) {
      // ä¸­ç¨‹åº¦ãƒãƒƒãƒ†ãƒªãƒ¼æ™‚ã¯é€šçŸ¥ã‚’æœ€é©åŒ–
      this.notificationStrategy = 'optimized';
      this.vibrationEnabled = true;
      this.soundEnabled = false;
    } else {
      // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰
      this.notificationStrategy = 'full';
      this.vibrationEnabled = true;
      this.soundEnabled = true;
    }
  }

  shouldSendNotification(notificationType, priority) {
    switch (this.notificationStrategy) {
      case 'critical_only':
        return priority === 'critical';
      
      case 'optimized':
        return priority === 'critical' || priority === 'high';
      
      case 'full':
      default:
        return true;
    }
  }
}
```

ã“ã®åŒ…æ‹¬çš„ãªé€šçŸ¥æˆ¦ç•¥ã«ã‚ˆã‚Šã€ç¾å®¹å®¤é¡§å®¢ã®æº€è¶³åº¦å‘ä¸Šã€äºˆç´„åŠ¹ç‡åŒ–ã€ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°åŠ¹æœã®æœ€å¤§åŒ–ã‚’å®Ÿç¾ã§ãã¾ã™ã€‚å€‹äººã®è¡Œå‹•ãƒ‘ã‚¿ãƒ¼ãƒ³ã«åŸºã¥ã„ãŸãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã•ã‚ŒãŸé€šçŸ¥ã§ã€ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆç‡ã‚’å¤§å¹…ã«å‘ä¸Šã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚